<!DOCTYPE html>

<html lang="zh-TW" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Netmem Support for Network Drivers &#8212; The Linux Kernel  說明文件</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=adfc0c0d" />
    <script src="../_static/documentation_options.js?v=0d9984b1"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/networking/netmem.html" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜尋" href="../search.html" />
    <link rel="next" title="Resilient Next-hop Groups" href="nexthop-group-resilient.html" />
    <link rel="prev" title="NETIF Msg Level" href="netif-msg.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.18.0-rc2</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜尋</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="前往" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">提交補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">行為守則</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">維護者手冊</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">核心 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">子系統</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#networking-interfaces">Networking interfaces</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">撰寫文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">開發工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">測試指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">建置系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">回報議題</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">使用者空間工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">使用者空間 API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">韌體</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">韌體與裝置樹</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU 架構</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">未排序的文件</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本頁</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/networking/netmem.rst.txt"
            rel="nofollow">顯示原始碼</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="netmem-support-for-network-drivers">
<h1>Netmem Support for Network Drivers<a class="headerlink" href="#netmem-support-for-network-drivers" title="連結到這個標頭">¶</a></h1>
<p>This document outlines the requirements for network drivers to support netmem,
an abstract memory type that enables features like device memory TCP. By
supporting netmem, drivers can work with various underlying memory types
with little to no modification.</p>
<p>Benefits of Netmem :</p>
<ul class="simple">
<li><p>Flexibility: Netmem can be backed by different memory types (e.g., <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">page</span></code>, DMA-buf), allowing drivers to support various use cases such as device
memory TCP.</p></li>
<li><p>Future-proof: Drivers with netmem support are ready for upcoming
features that rely on it.</p></li>
<li><p>Simplified Development: Drivers interact with a consistent API,
regardless of the underlying memory implementation.</p></li>
</ul>
<section id="driver-rx-requirements">
<h2>Driver RX Requirements<a class="headerlink" href="#driver-rx-requirements" title="連結到這個標頭">¶</a></h2>
<ol class="arabic">
<li><p>The driver must support page_pool.</p></li>
<li><p>The driver must support the tcp-data-split ethtool option.</p></li>
<li><p>The driver must use the page_pool netmem APIs for payload memory. The netmem
APIs currently 1-to-1 correspond with page APIs. Conversion to netmem should
be achievable by switching the page APIs to netmem APIs and tracking memory
via netmem_refs in the driver rather than <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span></code> * :</p>
<ul class="simple">
<li><p>page_pool_alloc -&gt; page_pool_alloc_netmem</p></li>
<li><p>page_pool_get_dma_addr -&gt; page_pool_get_dma_addr_netmem</p></li>
<li><p>page_pool_put_page -&gt; page_pool_put_netmem</p></li>
</ul>
<p>Not all page APIs have netmem equivalents at the moment. If your driver
relies on a missing netmem API, feel free to add and propose to netdev&#64;, or
reach out to the maintainers and/or <a class="reference external" href="mailto:almasrymina&#37;&#52;&#48;google&#46;com">almasrymina<span>&#64;</span>google<span>&#46;</span>com</a> for help adding
the netmem API.</p>
</li>
<li><p>The driver must use the following PP_FLAGS:</p>
<ul class="simple">
<li><p>PP_FLAG_DMA_MAP: netmem is not dma-mappable by the driver. The driver
must delegate the dma mapping to the page_pool, which knows when
dma-mapping is (or is not) appropriate.</p></li>
<li><p>PP_FLAG_DMA_SYNC_DEV: netmem dma addr is not necessarily dma-syncable
by the driver. The driver must delegate the dma syncing to the page_pool,
which knows when dma-syncing is (or is not) appropriate.</p></li>
<li><p>PP_FLAG_ALLOW_UNREADABLE_NETMEM. The driver must specify this flag iff
tcp-data-split is enabled.</p></li>
</ul>
</li>
<li><p>The driver must not assume the netmem is readable and/or backed by pages.
The netmem returned by the page_pool may be unreadable, in which case
<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">netmem_address()</span></code> will return NULL. The driver must correctly handle
unreadable netmem, i.e. don't attempt to handle its contents when
<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">netmem_address()</span></code> is NULL.</p>
<p>Ideally, drivers should not have to check the underlying netmem type via
helpers like <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">netmem_is_net_iov()</span></code> or convert the netmem to any of its
underlying types via <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">netmem_to_page()</span></code> or <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">netmem_to_net_iov()</span></code>. In most cases,
netmem or page_pool helpers that abstract this complexity are provided
(and more can be added).</p>
</li>
<li><p>The driver must use <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">page_pool_dma_sync_netmem_for_cpu()</span></code> in lieu of
<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">dma_sync_single_range_for_cpu()</span></code>. For some memory providers, dma_syncing for
CPU will be done by the page_pool, for others (particularly dmabuf memory
provider), dma syncing for CPU is the responsibility of the userspace using
dmabuf APIs. The driver must delegate the entire dma-syncing operation to
the page_pool which will do it correctly.</p></li>
<li><p>Avoid implementing driver-specific recycling on top of the page_pool. Drivers
cannot hold onto a <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span></code> to do their own recycling as the netmem may
not be backed by a <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span></code>. However, you may hold onto a page_pool
reference with <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">page_pool_fragment_netmem()</span></code> or <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">page_pool_ref_netmem()</span></code> for
that purpose, but be mindful that some netmem types might have longer
circulation times, such as when userspace holds a reference in zerocopy
scenarios.</p></li>
</ol>
</section>
<section id="driver-tx-requirements">
<h2>Driver TX Requirements<a class="headerlink" href="#driver-tx-requirements" title="連結到這個標頭">¶</a></h2>
<ol class="arabic">
<li><p>The Driver must not pass the netmem dma_addr to any of the dma-mapping APIs
directly. This is because netmem dma_addrs may come from a source like
dma-buf that is not compatible with the dma-mapping APIs.</p>
<p>Helpers like <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">netmem_dma_unmap_page_attrs()</span></code> &amp; <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">netmem_dma_unmap_addr_set()</span></code>
should be used in lieu of dma_unmap_page[_attrs](), <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">dma_unmap_addr_set()</span></code>.
The netmem variants will handle netmem dma_addrs correctly regardless of the
source, delegating to the dma-mapping APIs when appropriate.</p>
<p>Not all dma-mapping APIs have netmem equivalents at the moment. If your
driver relies on a missing netmem API, feel free to add and propose to
netdev&#64;, or reach out to the maintainers and/or <a class="reference external" href="mailto:almasrymina&#37;&#52;&#48;google&#46;com">almasrymina<span>&#64;</span>google<span>&#46;</span>com</a> for
help adding the netmem API.</p>
</li>
<li><p>Driver should declare support by setting <cite>netdev-&gt;netmem_tx = true</cite></p></li>
</ol>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/networking/netmem.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>