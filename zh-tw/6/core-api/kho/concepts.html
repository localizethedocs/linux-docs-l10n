<!DOCTYPE html>

<html lang="zh-TW" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Kexec Handover Concepts &#8212; The Linux Kernel unknown version 說明文件</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=b446b479"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/core-api/kho/concepts.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜尋" href="../../search.html" />
    <link rel="next" title="KHO FDT" href="fdt.html" />
    <link rel="prev" title="Kexec Handover Subsystem" href="index.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜尋</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="前往" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">提交補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">行為守則</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">維護者手冊</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">核心 API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#core-utilities">Core utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#data-structures-and-low-level-utilities">Data structures and low-level utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#low-level-entry-and-exit">低階進入與退出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#concurrency-primitives">Concurrency primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#low-level-hardware-management">Low-level hardware management</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#memory-management">記憶體管理</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../memory-allocation.html">Memory Allocation Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../unaligned-memory-access.html">Unaligned Memory Accesses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dma-api.html">Dynamic DMA mapping using the generic device</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dma-api-howto.html">Dynamic DMA mapping Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dma-attributes.html">DMA attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dma-isa-lpc.html">DMA with ISA and LPC devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../swiotlb.html">DMA and swiotlb</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mm-api.html">Memory Management APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cgroup.html">Cgroup Kernel APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../genalloc.html">The genalloc/genpool subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pin_user_pages.html">pin_user_pages() and related calls</a></li>
<li class="toctree-l3"><a class="reference internal" href="../boot-time-mm.html">Boot time memory management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gfp_mask-from-fs-io.html">GFP masks used from FS/IO context</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Kexec Handover Subsystem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#interfaces-for-kernel-debugging">Interfaces for kernel debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#everything-else">Everything else</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">子系統</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../subsystem-apis.html#core-subsystems">Core subsystems</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">核心 API 文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../driver-api/index.html">Driver implementer's API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mm/index.html">記憶體管理文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../power/index.html">電源管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../scheduler/index.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../timers/index.html">計時器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#other-subsystems">其他子系統</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">撰寫文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">開發工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">測試指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">即時補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">建置系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">回報議題</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">使用者空間工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">使用者空間 API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">韌體</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">韌體與裝置樹</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU 架構</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">未排序的文件</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本頁</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/core-api/kho/concepts.rst.txt"
            rel="nofollow">顯示原始碼</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="kexec-handover-concepts">
<span id="kho-concepts"></span><h1>Kexec Handover Concepts<a class="headerlink" href="#kexec-handover-concepts" title="連結到這個標頭">¶</a></h1>
<p>Kexec HandOver (KHO) is a mechanism that allows Linux to preserve memory
regions, which could contain serialized system states, across kexec.</p>
<p>It introduces multiple concepts:</p>
<section id="kho-fdt">
<h2>KHO FDT<a class="headerlink" href="#kho-fdt" title="連結到這個標頭">¶</a></h2>
<p>Every KHO kexec carries a KHO specific flattened device tree (FDT) blob
that describes preserved memory regions. These regions contain either
serialized subsystem states, or in-memory data that shall not be touched
across kexec. After KHO, subsystems can retrieve and restore preserved
memory regions from KHO FDT.</p>
<p>KHO only uses the FDT container format and libfdt library, but does not
adhere to the same property semantics that normal device trees do: Properties
are passed in native endianness and standardized properties like <code class="docutils literal notranslate"><span class="pre">regs</span></code> and
<code class="docutils literal notranslate"><span class="pre">ranges</span></code> do not exist, hence there are no <code class="docutils literal notranslate"><span class="pre">#...-cells</span></code> properties.</p>
<p>KHO is still under development. The FDT schema is unstable and would change
in the future.</p>
</section>
<section id="scratch-regions">
<h2>Scratch Regions<a class="headerlink" href="#scratch-regions" title="連結到這個標頭">¶</a></h2>
<p>To boot into kexec, we need to have a physically contiguous memory range that
contains no handed over memory. Kexec then places the target kernel and initrd
into that region. The new kernel exclusively uses this region for memory
allocations before during boot up to the initialization of the page allocator.</p>
<p>We guarantee that we always have such regions through the scratch regions: On
first boot KHO allocates several physically contiguous memory regions. Since
after kexec these regions will be used by early memory allocations, there is a
scratch region per NUMA node plus a scratch region to satisfy allocations
requests that do not require particular NUMA node assignment.
By default, size of the scratch region is calculated based on amount of memory
allocated during boot. The <code class="docutils literal notranslate"><span class="pre">kho_scratch</span></code> kernel command line option may be
used to explicitly define size of the scratch regions.
The scratch regions are declared as CMA when page allocator is initialized so
that their memory can be used during system lifetime. CMA gives us the
guarantee that no handover pages land in that region, because handover pages
must be at a static physical memory location and CMA enforces that only
movable pages can be located inside.</p>
<p>After KHO kexec, we ignore the <code class="docutils literal notranslate"><span class="pre">kho_scratch</span></code> kernel command line option and
instead reuse the exact same region that was originally allocated. This allows
us to recursively execute any amount of KHO kexecs. Because we used this region
for boot memory allocations and as target memory for kexec blobs, some parts
of that memory region may be reserved. These reservations are irrelevant for
the next KHO, because kexec can overwrite even the original kernel.</p>
</section>
<section id="kho-finalization-phase">
<span id="id1"></span><h2>KHO finalization phase<a class="headerlink" href="#kho-finalization-phase" title="連結到這個標頭">¶</a></h2>
<p>To enable user space based kexec file loader, the kernel needs to be able to
provide the FDT that describes the current kernel's state before
performing the actual kexec. The process of generating that FDT is
called serialization. When the FDT is generated, some properties
of the system may become immutable because they are already written down
in the FDT. That state is called the KHO finalization phase.</p>
</section>
<section id="public-api">
<h2>Public API<a class="headerlink" href="#public-api" title="連結到這個標頭">¶</a></h2>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_restore_folio">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../mm-api.html#c.folio" title="folio"><span class="n"><span class="pre">folio</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">kho_restore_folio</span></span></span><span class="sig-paren">(</span><span class="n"><span class="pre">phys_addr_t</span></span><span class="w"> </span><span class="n"><span class="pre">phys</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_restore_folio" title="連結到這個定義">¶</a><br /></dt>
<dd><p>recreates the folio from the preserved memory.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">phys_addr_t</span> <span class="pre">phys</span></code></dt><dd><p>physical address of the folio.</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>pointer to the <a class="reference internal" href="../mm-api.html#c.folio" title="folio"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">folio</span></code></a> on success, NULL on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_restore_pages">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">kho_restore_pages</span></span></span><span class="sig-paren">(</span><span class="n"><span class="pre">phys_addr_t</span></span><span class="w"> </span><span class="n"><span class="pre">phys</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">nr_pages</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_restore_pages" title="連結到這個定義">¶</a><br /></dt>
<dd><p>restore list of contiguous order 0 pages.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">phys_addr_t</span> <span class="pre">phys</span></code></dt><dd><p>physical address of the first page.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">nr_pages</span></code></dt><dd><p>number of pages.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Restore a contiguous list of order 0 pages that was preserved with
<a class="reference internal" href="#c.kho_preserve_pages" title="kho_preserve_pages"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_preserve_pages()</span></code></a>.</p>
<p><strong>Return</strong></p>
<p>0 on success, error code on failure</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_add_subtree">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_add_subtree</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">name</span></span>, <span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">fdt</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_add_subtree" title="連結到這個定義">¶</a><br /></dt>
<dd><p>record the physical address of a sub FDT in KHO root tree.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*name</span></code></dt><dd><p>name of the sub tree.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*fdt</span></code></dt><dd><p>the sub tree blob.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Creates a new child node named <strong>name</strong> in KHO root FDT and records
the physical address of <strong>fdt</strong>. The pages of <strong>fdt</strong> must also be preserved
by KHO for the new kernel to retrieve it after kexec.</p>
<p>A debugfs blob entry is also created at
<code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/sub_fdts/**name**</span></code> when kernel is configured with
CONFIG_KEXEC_HANDOVER_DEBUGFS</p>
<p><strong>Return</strong></p>
<p>0 on success, error code on failure</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_preserve_folio">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_preserve_folio</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.kho_preserve_folio" title="folio"><span class="n"><span class="pre">folio</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">folio</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_preserve_folio" title="連結到這個定義">¶</a><br /></dt>
<dd><p>preserve a folio across kexec.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">folio</span> <span class="pre">*folio</span></code></dt><dd><p>folio to preserve.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Instructs KHO to preserve the whole folio across kexec. The order
will be preserved as well.</p>
<p><strong>Return</strong></p>
<p>0 on success, error code on failure</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_unpreserve_folio">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_unpreserve_folio</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.kho_unpreserve_folio" title="folio"><span class="n"><span class="pre">folio</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">folio</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_unpreserve_folio" title="連結到這個定義">¶</a><br /></dt>
<dd><p>unpreserve a folio.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">folio</span> <span class="pre">*folio</span></code></dt><dd><p>folio to unpreserve.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Instructs KHO to unpreserve a folio that was preserved by
<a class="reference internal" href="#c.kho_preserve_folio" title="kho_preserve_folio"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_preserve_folio()</span></code></a> before. The provided <strong>folio</strong> (pfn and order)
must exactly match a previously preserved folio.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_preserve_pages">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_preserve_pages</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.kho_preserve_pages" title="page"><span class="n"><span class="pre">page</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">page</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">nr_pages</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_preserve_pages" title="連結到這個定義">¶</a><br /></dt>
<dd><p>preserve contiguous pages across kexec</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span> <span class="pre">*page</span></code></dt><dd><p>first page in the list.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">nr_pages</span></code></dt><dd><p>number of pages.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Preserve a contiguous list of order 0 pages. Must be restored using
<a class="reference internal" href="#c.kho_restore_pages" title="kho_restore_pages"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_restore_pages()</span></code></a> to ensure the pages are restored properly as order 0.</p>
<p><strong>Return</strong></p>
<p>0 on success, error code on failure</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_unpreserve_pages">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_unpreserve_pages</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.kho_unpreserve_pages" title="page"><span class="n"><span class="pre">page</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">page</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">nr_pages</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_unpreserve_pages" title="連結到這個定義">¶</a><br /></dt>
<dd><p>unpreserve contiguous pages.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span> <span class="pre">*page</span></code></dt><dd><p>first page in the list.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">nr_pages</span></code></dt><dd><p>number of pages.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Instructs KHO to unpreserve <strong>nr_pages</strong> contiguous pages starting from <strong>page</strong>.
This must be called with the same <strong>page</strong> and <strong>nr_pages</strong> as the corresponding
<a class="reference internal" href="#c.kho_preserve_pages" title="kho_preserve_pages"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_preserve_pages()</span></code></a> call. Unpreserving arbitrary sub-ranges of larger
preserved blocks is not supported.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_preserve_vmalloc">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_preserve_vmalloc</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">ptr</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">kho_vmalloc</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">preservation</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_preserve_vmalloc" title="連結到這個定義">¶</a><br /></dt>
<dd><p>preserve memory allocated with <a class="reference internal" href="../mm-api.html#c.vmalloc" title="vmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">vmalloc()</span></code></a> across kexec</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*ptr</span></code></dt><dd><p>pointer to the area in vmalloc address space</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kho_vmalloc</span> <span class="pre">*preservation</span></code></dt><dd><p>placeholder for preservation metadata</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Instructs KHO to preserve the area in vmalloc address space at <strong>ptr</strong>. The
physical pages mapped at <strong>ptr</strong> will be preserved and on successful return
<strong>preservation</strong> will hold the physical address of a structure that describes
the preservation.</p>
<p><strong>NOTE</strong></p>
<p>The memory allocated with <a class="reference internal" href="../mm-api.html#c.vmalloc_node" title="vmalloc_node"><code class="xref c c-func docutils literal notranslate"><span class="pre">vmalloc_node()</span></code></a> variants cannot be reliably
restored on the same node</p>
<p><strong>Return</strong></p>
<p>0 on success, error code on failure</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_unpreserve_vmalloc">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_unpreserve_vmalloc</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">kho_vmalloc</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">preservation</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_unpreserve_vmalloc" title="連結到這個定義">¶</a><br /></dt>
<dd><p>unpreserve memory allocated with <a class="reference internal" href="../mm-api.html#c.vmalloc" title="vmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">vmalloc()</span></code></a></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kho_vmalloc</span> <span class="pre">*preservation</span></code></dt><dd><p>preservation metadata returned by <a class="reference internal" href="#c.kho_preserve_vmalloc" title="kho_preserve_vmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_preserve_vmalloc()</span></code></a></p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Instructs KHO to unpreserve the area in vmalloc address space that was
previously preserved with <a class="reference internal" href="#c.kho_preserve_vmalloc" title="kho_preserve_vmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_preserve_vmalloc()</span></code></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_restore_vmalloc">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">kho_restore_vmalloc</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">kho_vmalloc</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">preservation</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_restore_vmalloc" title="連結到這個定義">¶</a><br /></dt>
<dd><p>recreates and populates an area in vmalloc address space from the preserved memory.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">kho_vmalloc</span> <span class="pre">*preservation</span></code></dt><dd><p>preservation metadata.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Recreates an area in vmalloc address space and populates it with memory that
was preserved using <a class="reference internal" href="#c.kho_preserve_vmalloc" title="kho_preserve_vmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_preserve_vmalloc()</span></code></a>.</p>
<p><strong>Return</strong></p>
<p>pointer to the area in the vmalloc address space, NULL on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_alloc_preserve">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">kho_alloc_preserve</span></span></span><span class="sig-paren">(</span><span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">size</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_alloc_preserve" title="連結到這個定義">¶</a><br /></dt>
<dd><p>Allocate, zero, and preserve memory.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">size</span></code></dt><dd><p>The number of bytes to allocate.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Allocates a physically contiguous block of zeroed pages that is large
enough to hold <strong>size</strong> bytes. The allocated memory is then registered with
KHO for preservation across a kexec.</p>
<p><strong>Note</strong></p>
<p>The actual allocated size will be rounded up to the nearest
power-of-two page boundary.</p>
<p><strong>return</strong> A virtual pointer to the allocated and preserved memory on success,
or an <a class="reference internal" href="../kernel-api.html#c.ERR_PTR" title="ERR_PTR"><code class="xref c c-func docutils literal notranslate"><span class="pre">ERR_PTR()</span></code></a> encoded error on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_unpreserve_free">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_unpreserve_free</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mem</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_unpreserve_free" title="連結到這個定義">¶</a><br /></dt>
<dd><p>Unpreserve and free memory.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*mem</span></code></dt><dd><p>Pointer to the memory allocated by <a class="reference internal" href="#c.kho_alloc_preserve" title="kho_alloc_preserve"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_alloc_preserve()</span></code></a>.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Unregisters the memory from KHO preservation and frees the underlying
pages back to the system. This function should be called to clean up
memory allocated with <a class="reference internal" href="#c.kho_alloc_preserve" title="kho_alloc_preserve"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_alloc_preserve()</span></code></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_restore_free">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_restore_free</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mem</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_restore_free" title="連結到這個定義">¶</a><br /></dt>
<dd><p>Restore and free memory after kexec.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*mem</span></code></dt><dd><p>Pointer to the memory (in the new kernel's address space)
that was allocated by the old kernel.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function is intended to be called in the new kernel (post-kexec)
to take ownership of and free a memory region that was preserved by the
old kernel using <a class="reference internal" href="#c.kho_alloc_preserve" title="kho_alloc_preserve"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_alloc_preserve()</span></code></a>.</p>
<p>It first restores the pages from KHO (using their physical address)
and then frees the pages back to the new kernel's page allocator.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.is_kho_boot">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">is_kho_boot</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">void</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.is_kho_boot" title="連結到這個定義">¶</a><br /></dt>
<dd><p>check if current kernel was booted via KHO-enabled kexec</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt><dd><p>no arguments</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function checks if the current kernel was loaded through a kexec
operation with KHO enabled, by verifying that a valid KHO FDT
was passed.</p>
<p><strong>Note</strong></p>
<p>This function returns reliable results only after
<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">kho_populate()</span></code> has been called during early boot. Before that,
it may return false even if KHO data is present.</p>
<p><strong>Return</strong></p>
<p>true if booted via KHO-enabled kexec, false otherwise</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.kho_retrieve_subtree">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">kho_retrieve_subtree</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">name</span></span>, <span class="n"><span class="pre">phys_addr_t</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">phys</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.kho_retrieve_subtree" title="連結到這個定義">¶</a><br /></dt>
<dd><p>retrieve a preserved sub FDT by its name.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*name</span></code></dt><dd><p>the name of the sub FDT passed to <a class="reference internal" href="#c.kho_add_subtree" title="kho_add_subtree"><code class="xref c c-func docutils literal notranslate"><span class="pre">kho_add_subtree()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">phys_addr_t</span> <span class="pre">*phys</span></code></dt><dd><p>if found, the physical address of the sub FDT is stored in <strong>phys</strong>.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Retrieve a preserved sub FDT named <strong>name</strong> and store its physical
address in <strong>phys</strong>.</p>
<p><strong>Return</strong></p>
<p>0 on success, error code on failure</p>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/core-api/kho/concepts.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>