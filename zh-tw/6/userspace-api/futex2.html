<!DOCTYPE html>

<html lang="zh-TW" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>futex2 &#8212; The Linux Kernel unknown version 說明文件</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=adfc0c0d" />
    <script src="../_static/documentation_options.js?v=b446b479"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/userspace-api/futex2.html" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜尋" href="../search.html" />
    <link rel="next" title="eBPF Userspace API" href="ebpf/index.html" />
    <link rel="prev" title="unshare system call" href="unshare.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜尋</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="前往" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">提交補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">行為守則</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">維護者手冊</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">核心 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../subsystem-apis.html">子系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">撰寫文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">開發工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">測試指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">即時補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">建置系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">回報議題</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">使用者空間工具</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">使用者空間 API</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#system-calls">System calls</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="unshare.html">unshare system call</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">futex2</a></li>
<li class="toctree-l3"><a class="reference internal" href="ebpf/index.html">eBPF Userspace API</a></li>
<li class="toctree-l3"><a class="reference internal" href="ioctl/index.html">IOCTLs</a></li>
<li class="toctree-l3"><a class="reference internal" href="mseal.html">Introduction of mseal</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#security-related-interfaces">Security-related interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#devices-and-i-o">Devices and I/O</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#everything-else">Everything else</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ELF.html">Linux-specific ELF idiosyncrasies</a></li>
<li class="toctree-l3"><a class="reference internal" href="liveupdate.html">Live Update uAPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="netlink/index.html">Netlink Handbook</a></li>
<li class="toctree-l3"><a class="reference internal" href="sysfs-platform_profile.html">Platform Profile Selection (e.g. /sys/firmware/acpi/platform_profile)</a></li>
<li class="toctree-l3"><a class="reference internal" href="vduse.html">VDUSE - &quot;vDPA Device in Userspace&quot;</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">futex2</a></li>
<li class="toctree-l3"><a class="reference internal" href="perf_ring_buffer.html">Perf ring buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="ntsync.html">NT synchronization primitive driver</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">韌體</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">韌體與裝置樹</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU 架構</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">未排序的文件</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本頁</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/userspace-api/futex2.rst.txt"
            rel="nofollow">顯示原始碼</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="futex2">
<h1>futex2<a class="headerlink" href="#futex2" title="連結到這個標頭">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">作者<span class="colon">:</span></dt>
<dd class="field-odd"><p>André Almeida &lt;<a class="reference external" href="mailto:andrealmeid&#37;&#52;&#48;collabora&#46;com">andrealmeid<span>&#64;</span>collabora<span>&#46;</span>com</a>&gt;</p>
</dd>
</dl>
<p>futex, or fast user mutex, is a set of syscalls to allow userspace to create
performant synchronization mechanisms, such as mutexes, semaphores and
conditional variables in userspace. C standard libraries, like glibc, uses it
as a means to implement more high level interfaces like pthreads.</p>
<p>futex2 is a followup version of the initial futex syscall, designed to overcome
limitations of the original interface.</p>
<section id="user-api">
<h2>使用者 API<a class="headerlink" href="#user-api" title="連結到這個標頭">¶</a></h2>
<section id="futex-waitv">
<h3><code class="docutils literal notranslate"><span class="pre">futex_waitv()</span></code><a class="headerlink" href="#futex-waitv" title="連結到這個標頭">¶</a></h3>
<p>Wait on an array of futexes, wake on any:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>futex_waitv(struct futex_waitv *waiters, unsigned int nr_futexes,
            unsigned int flags, struct timespec *timeout, clockid_t clockid)

struct futex_waitv {
      __u64 val;
      __u64 uaddr;
      __u32 flags;
      __u32 __reserved;
};
</pre></div>
</div>
<p>Userspace sets an array of <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span> <span class="pre">futex_waitv</span></code> (up to a max of 128 entries),
using <code class="docutils literal notranslate"><span class="pre">uaddr</span></code> for the address to wait for, <code class="docutils literal notranslate"><span class="pre">val</span></code> for the expected value
and <code class="docutils literal notranslate"><span class="pre">flags</span></code> to specify the type (e.g. private) and size of futex.
<code class="docutils literal notranslate"><span class="pre">__reserved</span></code> needs to be 0, but it can be used for future extension. The
pointer for the first item of the array is passed as <code class="docutils literal notranslate"><span class="pre">waiters</span></code>. An invalid
address for <code class="docutils literal notranslate"><span class="pre">waiters</span></code> or for any <code class="docutils literal notranslate"><span class="pre">uaddr</span></code> returns <code class="docutils literal notranslate"><span class="pre">-EFAULT</span></code>.</p>
<p>If userspace has 32-bit pointers, it should do a explicit cast to make sure
the upper bits are zeroed. <code class="docutils literal notranslate"><span class="pre">uintptr_t</span></code> does the tricky and it works for
both 32/64-bit pointers.</p>
<p><code class="docutils literal notranslate"><span class="pre">nr_futexes</span></code> specifies the size of the array. Numbers out of [1, 128]
interval will make the syscall return <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">flags</span></code> argument of the syscall needs to be 0, but it can be used for
future extension.</p>
<p>For each entry in <code class="docutils literal notranslate"><span class="pre">waiters</span></code> array, the current value at <code class="docutils literal notranslate"><span class="pre">uaddr</span></code> is compared
to <code class="docutils literal notranslate"><span class="pre">val</span></code>. If it's different, the syscall undo all the work done so far and
return <code class="docutils literal notranslate"><span class="pre">-EAGAIN</span></code>. If all tests and verifications succeeds, syscall waits until
one of the following happens:</p>
<ul class="simple">
<li><p>The timeout expires, returning <code class="docutils literal notranslate"><span class="pre">-ETIMEOUT</span></code>.</p></li>
<li><p>A signal was sent to the sleeping task, returning <code class="docutils literal notranslate"><span class="pre">-ERESTARTSYS</span></code>.</p></li>
<li><p>Some futex at the list was woken, returning the index of some waked futex.</p></li>
</ul>
<p>An example of how to use the interface can be found at <code class="docutils literal notranslate"><span class="pre">tools/testing/selftests/futex/functional/futex_waitv.c</span></code>.</p>
</section>
<section id="timeout">
<h3>Timeout<a class="headerlink" href="#timeout" title="連結到這個標頭">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">timespec</span> <span class="pre">*timeout</span></code> argument is an optional argument that points to an
absolute timeout. You need to specify the type of clock being used at
<code class="docutils literal notranslate"><span class="pre">clockid</span></code> argument. <code class="docutils literal notranslate"><span class="pre">CLOCK_MONOTONIC</span></code> and <code class="docutils literal notranslate"><span class="pre">CLOCK_REALTIME</span></code> are supported.
This syscall accepts only 64bit timespec structs.</p>
</section>
<section id="types-of-futex">
<h3>Types of futex<a class="headerlink" href="#types-of-futex" title="連結到這個標頭">¶</a></h3>
<p>A futex can be either private or shared. Private is used for processes that
shares the same memory space and the virtual address of the futex will be the
same for all processes. This allows for optimizations in the kernel. To use
private futexes, it's necessary to specify <code class="docutils literal notranslate"><span class="pre">FUTEX_PRIVATE_FLAG</span></code> in the futex
flag. For processes that doesn't share the same memory space and therefore can
have different virtual addresses for the same futex (using, for instance, a
file-backed shared memory) requires different internal mechanisms to be get
properly enqueued. This is the default behavior, and it works with both private
and shared futexes.</p>
<p>Futexes can be of different sizes: 8, 16, 32 or 64 bits. Currently, the only
supported one is 32 bit sized futex, and it need to be specified using
<code class="docutils literal notranslate"><span class="pre">FUTEX_32</span></code> flag.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/userspace-api/futex2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>