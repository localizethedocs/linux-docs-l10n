<!DOCTYPE html>

<html lang="zh-TW" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Speculation Control &#8212; The Linux Kernel unknown version 說明文件</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=adfc0c0d" />
    <script src="../_static/documentation_options.js?v=b446b479"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/userspace-api/spec_ctrl.html" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜尋" href="../search.html" />
    <link rel="next" title="TEE (Trusted Execution Environment) Userspace API" href="tee.html" />
    <link rel="prev" title="Introduction of non-executable mfd" href="mfd_noexec.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜尋</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="前往" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">提交補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">行為守則</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">維護者手冊</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">核心 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../subsystem-apis.html">子系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">撰寫文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">開發工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">測試指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">即時補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">建置系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">回報議題</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">使用者空間工具</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">使用者空間 API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#system-calls">System calls</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#security-related-interfaces">Security-related interfaces</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="no_new_privs.html">No New Privileges Flag</a></li>
<li class="toctree-l3"><a class="reference internal" href="seccomp_filter.html">Seccomp BPF (SECure COMPuting with filters)</a></li>
<li class="toctree-l3"><a class="reference internal" href="landlock.html">Landlock: unprivileged access control</a></li>
<li class="toctree-l3"><a class="reference internal" href="lsm.html">Linux Security Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="mfd_noexec.html">Introduction of non-executable mfd</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Speculation Control</a></li>
<li class="toctree-l3"><a class="reference internal" href="tee.html">TEE (Trusted Execution Environment) Userspace API</a></li>
<li class="toctree-l3"><a class="reference internal" href="check_exec.html">Executability check</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#devices-and-i-o">Devices and I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#everything-else">Everything else</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">韌體</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">韌體與裝置樹</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU 架構</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">未排序的文件</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本頁</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/userspace-api/spec_ctrl.rst.txt"
            rel="nofollow">顯示原始碼</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="speculation-control">
<h1>Speculation Control<a class="headerlink" href="#speculation-control" title="連結到這個標頭">¶</a></h1>
<p>Quite some CPUs have speculation-related misfeatures which are in
fact vulnerabilities causing data leaks in various forms even across
privilege domains.</p>
<p>The kernel provides mitigation for such vulnerabilities in various
forms. Some of these mitigations are compile-time configurable and some
can be supplied on the kernel command line.</p>
<p>There is also a class of mitigations which are very expensive, but they can
be restricted to a certain set of processes or tasks in controlled
environments. The mechanism to control these mitigations is via
<em class="manpage">prctl(2)</em>.</p>
<p>There are two prctl options which are related to this:</p>
<blockquote>
<div><ul class="simple">
<li><p>PR_GET_SPECULATION_CTRL</p></li>
<li><p>PR_SET_SPECULATION_CTRL</p></li>
</ul>
</div></blockquote>
<section id="pr-get-speculation-ctrl">
<h2>PR_GET_SPECULATION_CTRL<a class="headerlink" href="#pr-get-speculation-ctrl" title="連結到這個標頭">¶</a></h2>
<p>PR_GET_SPECULATION_CTRL returns the state of the speculation misfeature
which is selected with arg2 of prctl(2). The return value uses bits 0-3 with
the following meaning (with the caveat that PR_SPEC_L1D_FLUSH has less obvious
semantics, see documentation for that specific control below):</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Bit</p></th>
<th class="head"><p>Define</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>PR_SPEC_PRCTL</p></td>
<td><p>Mitigation can be controlled per task by
PR_SET_SPECULATION_CTRL.</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>PR_SPEC_ENABLE</p></td>
<td><p>The speculation feature is enabled, mitigation is
disabled.</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>PR_SPEC_DISABLE</p></td>
<td><p>The speculation feature is disabled, mitigation is
enabled.</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>PR_SPEC_FORCE_DISABLE</p></td>
<td><p>Same as PR_SPEC_DISABLE, but cannot be undone. A
subsequent prctl(..., PR_SPEC_ENABLE) will fail.</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>PR_SPEC_DISABLE_NOEXEC</p></td>
<td><p>Same as PR_SPEC_DISABLE, but the state will be
cleared on <em class="manpage">execve(2)</em>.</p></td>
</tr>
</tbody>
</table>
<p>If all bits are 0 the CPU is not affected by the speculation misfeature.</p>
<p>If PR_SPEC_PRCTL is set, then the per-task control of the mitigation is
available. If not set, prctl(PR_SET_SPECULATION_CTRL) for the speculation
misfeature will fail.</p>
</section>
<section id="pr-set-speculation-ctrl">
<span id="set-spec-ctrl"></span><h2>PR_SET_SPECULATION_CTRL<a class="headerlink" href="#pr-set-speculation-ctrl" title="連結到這個標頭">¶</a></h2>
<p>PR_SET_SPECULATION_CTRL allows to control the speculation misfeature, which
is selected by arg2 of <em class="manpage">prctl(2)</em> per task. arg3 is used to hand
in the control value, i.e. either PR_SPEC_ENABLE or PR_SPEC_DISABLE or
PR_SPEC_FORCE_DISABLE.</p>
</section>
<section id="common-error-codes">
<h2>Common error codes<a class="headerlink" href="#common-error-codes" title="連結到這個標頭">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>EINVAL</p></td>
<td><p>The prctl is not implemented by the architecture or unused
prctl(2) arguments are not 0.</p></td>
</tr>
<tr class="row-odd"><td><p>ENODEV</p></td>
<td><p>arg2 is selecting a not supported speculation misfeature.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="pr-set-speculation-ctrl-error-codes">
<h2>PR_SET_SPECULATION_CTRL error codes<a class="headerlink" href="#pr-set-speculation-ctrl-error-codes" title="連結到這個標頭">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Success</p></td>
</tr>
<tr class="row-odd"><td><p>ERANGE</p></td>
<td><p>arg3 is incorrect, i.e. it's neither PR_SPEC_ENABLE nor
PR_SPEC_DISABLE nor PR_SPEC_FORCE_DISABLE.</p></td>
</tr>
<tr class="row-even"><td><p>ENXIO</p></td>
<td><p>Control of the selected speculation misfeature is not possible.
See PR_GET_SPECULATION_CTRL.</p></td>
</tr>
<tr class="row-odd"><td><p>EPERM</p></td>
<td><p>Speculation was disabled with PR_SPEC_FORCE_DISABLE and caller
tried to enable it again.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="speculation-misfeature-controls">
<h2>Speculation misfeature controls<a class="headerlink" href="#speculation-misfeature-controls" title="連結到這個標頭">¶</a></h2>
<ul>
<li><p>PR_SPEC_STORE_BYPASS: Speculative Store Bypass</p>
<dl class="simple">
<dt>Invocations:</dt><dd><ul class="simple">
<li><p>prctl(PR_GET_SPECULATION_CTRL, PR_SPEC_STORE_BYPASS, 0, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_STORE_BYPASS, PR_SPEC_ENABLE, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_STORE_BYPASS, PR_SPEC_DISABLE, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_STORE_BYPASS, PR_SPEC_FORCE_DISABLE, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_STORE_BYPASS, PR_SPEC_DISABLE_NOEXEC, 0, 0);</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>PR_SPEC_INDIR_BRANCH: Indirect Branch Speculation in User Processes</dt><dd><p>(Mitigate Spectre V2 style attacks against user processes)</p>
</dd>
<dt>Invocations:</dt><dd><ul class="simple">
<li><p>prctl(PR_GET_SPECULATION_CTRL, PR_SPEC_INDIRECT_BRANCH, 0, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_INDIRECT_BRANCH, PR_SPEC_ENABLE, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_INDIRECT_BRANCH, PR_SPEC_DISABLE, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_INDIRECT_BRANCH, PR_SPEC_FORCE_DISABLE, 0, 0);</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>PR_SPEC_L1D_FLUSH: Flush L1D Cache on context switch out of the task</dt><dd><p>(works only when tasks run on non SMT cores)</p>
</dd>
</dl>
</li>
</ul>
<p>For this control, PR_SPEC_ENABLE means that the <strong>mitigation</strong> is enabled (L1D
is flushed), PR_SPEC_DISABLE means it is disabled.</p>
<blockquote>
<div><dl class="simple">
<dt>Invocations:</dt><dd><ul class="simple">
<li><p>prctl(PR_GET_SPECULATION_CTRL, PR_SPEC_L1D_FLUSH, 0, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_L1D_FLUSH, PR_SPEC_ENABLE, 0, 0);</p></li>
<li><p>prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_L1D_FLUSH, PR_SPEC_DISABLE, 0, 0);</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/userspace-api/spec_ctrl.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>