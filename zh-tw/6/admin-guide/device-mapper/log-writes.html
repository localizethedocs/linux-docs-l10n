<!DOCTYPE html>

<html lang="zh-TW" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>dm-log-writes &#8212; The Linux Kernel unknown version 說明文件</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=b446b479"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/admin-guide/device-mapper/log-writes.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜尋" href="../../search.html" />
    <link rel="next" title="Persistent data" href="persistent-data.html" />
    <link rel="prev" title="dm-linear" href="linear.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜尋</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="前往" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">提交補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">行為守則</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">維護者手冊</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">核心 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">子系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">撰寫文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">開發工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">測試指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">即時補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Administration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#general-guides-to-kernel-administration">General guides to kernel administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#booting-the-kernel">Booting the kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tracking-down-and-identifying-problems">Tracking down and identifying problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#core-kernel-subsystems">Core-kernel subsystems</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#block-layer-and-filesystem-administration">Block-layer and filesystem administration</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../bcache.html">A block layer cache (bcache)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../binderfs.html">The Android binderfs Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../blockdev/index.html">Block Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cifs/index.html">CIFS</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Device Mapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext4.html">ext4 General Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="../filesystem-monitoring.html">File system Monitoring with fanotify</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nfs/index.html">NFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../iostats.html">I/O statistics fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jfs.html">IBM's Journaled File System (JFS) for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../md.html">RAID arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ufs.html">Using UFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xfs.html">The SGI XFS Filesystem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#device-specific-guides">Device-specific guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#workload-analysis">Workload analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#everything-else">Everything else</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">建置系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reporting-issues.html">回報議題</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">使用者空間工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">使用者空間 API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">韌體</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">韌體與裝置樹</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU 架構</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">未排序的文件</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本頁</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/device-mapper/log-writes.rst.txt"
            rel="nofollow">顯示原始碼</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="dm-log-writes">
<h1>dm-log-writes<a class="headerlink" href="#dm-log-writes" title="連結到這個標頭">¶</a></h1>
<p>This target takes 2 devices, one to pass all IO to normally, and one to log all
of the write operations to.  This is intended for file system developers wishing
to verify the integrity of metadata or data as the file system is written to.
There is a log_write_entry written for every WRITE request and the target is
able to take arbitrary data from userspace to insert into the log.  The data
that is in the WRITE requests is copied into the log to make the replay happen
exactly as it happened originally.</p>
<section id="log-ordering">
<h2>Log Ordering<a class="headerlink" href="#log-ordering" title="連結到這個標頭">¶</a></h2>
<p>We log things in order of completion once we are sure the write is no longer in
cache.  This means that normal WRITE requests are not actually logged until the
next REQ_PREFLUSH request.  This is to make it easier for userspace to replay
the log in a way that correlates to what is on disk and not what is in cache,
to make it easier to detect improper waiting/flushing.</p>
<p>This works by attaching all WRITE requests to a list once the write completes.
Once we see a REQ_PREFLUSH request we splice this list onto the request and once
the FLUSH request completes we log all of the WRITEs and then the FLUSH.  Only
completed WRITEs, at the time the REQ_PREFLUSH is issued, are added in order to
simulate the worst case scenario with regard to power failures.  Consider the
following example (W means write, C means complete):</p>
<blockquote>
<div><p>W1,W2,W3,C3,C2,Wflush,C1,Cflush</p>
</div></blockquote>
<p>The log would show the following:</p>
<blockquote>
<div><p>W3,W2,flush,W1....</p>
</div></blockquote>
<p>Again this is to simulate what is actually on disk, this allows us to detect
cases where a power failure at a particular point in time would create an
inconsistent file system.</p>
<p>Any REQ_FUA requests bypass this flushing mechanism and are logged as soon as
they complete as those requests will obviously bypass the device cache.</p>
<p>Any REQ_OP_DISCARD requests are treated like WRITE requests.  Otherwise we would
have all the DISCARD requests, and then the WRITE requests and then the FLUSH
request.  Consider the following example:</p>
<blockquote>
<div><p>WRITE block 1, DISCARD block 1, FLUSH</p>
</div></blockquote>
<p>If we logged DISCARD when it completed, the replay would look like this:</p>
<blockquote>
<div><p>DISCARD 1, WRITE 1, FLUSH</p>
</div></blockquote>
<p>which isn't quite what happened and wouldn't be caught during the log replay.</p>
</section>
<section id="target-interface">
<h2>Target interface<a class="headerlink" href="#target-interface" title="連結到這個標頭">¶</a></h2>
<ol class="lowerroman">
<li><p>Constructor</p>
<p>log-writes &lt;dev_path&gt; &lt;log_dev_path&gt;</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>dev_path</p></td>
<td><p>Device that all of the IO will go to normally.</p></td>
</tr>
<tr class="row-even"><td><p>log_dev_path</p></td>
<td><p>Device where the log entries are written to.</p></td>
</tr>
</tbody>
</table>
</li>
<li><p>狀態</p>
<p>&lt;#logged entries&gt; &lt;highest allocated sector&gt;</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>#logged entries</p></td>
<td><p>Number of logged entries</p></td>
</tr>
<tr class="row-even"><td><p>highest allocated sector</p></td>
<td><p>Highest allocated sector</p></td>
</tr>
</tbody>
</table>
</li>
<li><p>Messages</p></li>
</ol>
<blockquote>
<div><p>mark &lt;description&gt;</p>
<blockquote>
<div><p>You can use a dmsetup message to set an arbitrary mark in a log.
For example say you want to fsck a file system after every
write, but first you need to replay up to the mkfs to make sure
we're fsck'ing something reasonable, you would do something like
this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mkfs.btrfs -f /dev/mapper/log
dmsetup message log 0 mark mkfs
&lt;run test&gt;
</pre></div>
</div>
<p>This would allow you to replay the log up to the mkfs mark and
then replay from that point on doing the fsck check in the
interval that you want.</p>
<p>Every log has a mark at the end labeled &quot;dm-log-writes-end&quot;.</p>
</div></blockquote>
</div></blockquote>
</section>
<section id="userspace-component">
<h2>Userspace component<a class="headerlink" href="#userspace-component" title="連結到這個標頭">¶</a></h2>
<p>There is a userspace tool that will replay the log for you in various ways.
It can be found here: <a class="reference external" href="https://github.com/josefbacik/log-writes">https://github.com/josefbacik/log-writes</a></p>
</section>
<section id="example-usage">
<h2>Example usage<a class="headerlink" href="#example-usage" title="連結到這個標頭">¶</a></h2>
<p>Say you want to test fsync on your file system.  You would do something like
this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TABLE=&quot;0 $(blockdev --getsz /dev/sdb) log-writes /dev/sdb /dev/sdc&quot;
dmsetup create log --table &quot;$TABLE&quot;
mkfs.btrfs -f /dev/mapper/log
dmsetup message log 0 mark mkfs

mount /dev/mapper/log /mnt/btrfs-test
&lt;some test that does fsync at the end&gt;
dmsetup message log 0 mark fsync
md5sum /mnt/btrfs-test/foo
umount /mnt/btrfs-test

dmsetup remove log
replay-log --log /dev/sdc --replay /dev/sdb --end-mark fsync
mount /dev/sdb /mnt/btrfs-test
md5sum /mnt/btrfs-test/foo
&lt;verify md5sum&#39;s are correct&gt;

Another option is to do a complicated file system operation and verify the file
system is consistent during the entire operation.  You could do this with:

TABLE=&quot;0 $(blockdev --getsz /dev/sdb) log-writes /dev/sdb /dev/sdc&quot;
dmsetup create log --table &quot;$TABLE&quot;
mkfs.btrfs -f /dev/mapper/log
dmsetup message log 0 mark mkfs

mount /dev/mapper/log /mnt/btrfs-test
&lt;fsstress to dirty the fs&gt;
btrfs filesystem balance /mnt/btrfs-test
umount /mnt/btrfs-test
dmsetup remove log

replay-log --log /dev/sdc --replay /dev/sdb --end-mark mkfs
btrfsck /dev/sdb
replay-log --log /dev/sdc --replay /dev/sdb --start-mark mkfs \
      --fsck &quot;btrfsck /dev/sdb&quot; --check fua
</pre></div>
</div>
<p>And that will replay the log until it sees a FUA request, run the fsck command
and if the fsck passes it will replay to the next FUA, until it is completed or
the fsck command exists abnormally.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/admin-guide/device-mapper/log-writes.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>