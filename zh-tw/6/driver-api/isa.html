<!DOCTYPE html>

<html lang="zh-TW" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>ISA Drivers &#8212; The Linux Kernel unknown version 說明文件</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=adfc0c0d" />
    <script src="../_static/documentation_options.js?v=b446b479"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/driver-api/isa.html" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜尋" href="../search.html" />
    <link rel="next" title="MEN Chameleon Bus" href="men-chameleon-bus.html" />
    <link rel="prev" title="I3C master controller driver API" href="i3c/master-driver-api.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜尋</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="前往" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">提交補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">行為守則</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">維護者手冊</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">核心 API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Driver APIs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#general-information-for-driver-authors">General information for driver authors</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#useful-support-libraries">Useful support libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#bus-level-documentation">Bus-level documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="auxiliary_bus.html">Auxiliary Bus</a></li>
<li class="toctree-l3"><a class="reference internal" href="cxl/index.html">Compute Express Link</a></li>
<li class="toctree-l3"><a class="reference internal" href="eisa.html">EISA bus support</a></li>
<li class="toctree-l3"><a class="reference internal" href="firewire.html">Firewire (IEEE 1394) driver Interface Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="i3c/index.html">I3C subsystem</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">ISA Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="men-chameleon-bus.html">MEN Chameleon Bus</a></li>
<li class="toctree-l3"><a class="reference internal" href="pci/index.html">The Linux PCI driver implementer's API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="rapidio/index.html">Linux RapidIO 子系統</a></li>
<li class="toctree-l3"><a class="reference internal" href="slimbus.html">Linux kernel SLIMbus support</a></li>
<li class="toctree-l3"><a class="reference internal" href="usb/index.html">Linux USB API</a></li>
<li class="toctree-l3"><a class="reference internal" href="virtio/index.html">Virtio</a></li>
<li class="toctree-l3"><a class="reference internal" href="vme.html">VME Device Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="w1.html">W1: Dallas' 1-wire bus</a></li>
<li class="toctree-l3"><a class="reference internal" href="xillybus.html">Xillybus driver for generic FPGA interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#subsystem-specific-apis">Subsystem-specific APIs</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">子系統</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#core-subsystems">Core subsystems</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../core-api/index.html">核心 API 文件</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Driver implementer's API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mm/index.html">記憶體管理文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../power/index.html">電源管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scheduler/index.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../timers/index.html">計時器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#other-subsystems">其他子系統</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">撰寫文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">開發工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">測試指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">即時補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">建置系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">回報議題</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">使用者空間工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">使用者空間 API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">韌體</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">韌體與裝置樹</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU 架構</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">未排序的文件</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本頁</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/driver-api/isa.rst.txt"
            rel="nofollow">顯示原始碼</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="isa-drivers">
<h1>ISA Drivers<a class="headerlink" href="#isa-drivers" title="連結到這個標頭">¶</a></h1>
<p>The following text is adapted from the commit message of the initial
commit of the ISA bus driver authored by Rene Herman.</p>
<p>During the recent &quot;isa drivers using platform devices&quot; discussion it was
pointed out that (ALSA) ISA drivers ran into the problem of not having
the option to fail driver load (device registration rather) upon not
finding their hardware due to a <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">probe()</span></code> error not being passed up
through the driver model. In the course of that, I suggested a separate
ISA bus might be best; Russell King agreed and suggested this bus could
use the .<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">match()</span></code> method for the actual device discovery.</p>
<p>The attached does this. For this old non (generically) discoverable ISA
hardware only the driver itself can do discovery so as a difference with
the platform_bus, this isa_bus also distributes <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">match()</span></code> up to the
driver.</p>
<p>As another difference: these devices only exist in the driver model due
to the driver creating them because it might want to drive them, meaning
that all device creation has been made internal as well.</p>
<p>The usage model this provides is nice, and has been acked from the ALSA
side by Takashi Iwai and Jaroslav Kysela. The ALSA driver module_init's
now (for oldisa-only drivers) become:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static int __init alsa_card_foo_init(void)
{
        return isa_register_driver(&amp;snd_foo_isa_driver, SNDRV_CARDS);
}

static void __exit alsa_card_foo_exit(void)
{
        isa_unregister_driver(&amp;snd_foo_isa_driver);
}
</pre></div>
</div>
<p>Quite like the other bus models therefore. This removes a lot of
duplicated init code from the ALSA ISA drivers.</p>
<p>The passed in isa_driver <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span> <span class="pre">is</span></code> the regular driver <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span> <span class="pre">embedding</span></code> a
<a class="reference internal" href="infrastructure.html#c.device_driver" title="device_driver"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device_driver</span></code></a>, the normal probe/remove/shutdown/suspend/resume
callbacks, and as indicated that .match callback.</p>
<p>The &quot;SNDRV_CARDS&quot; you see being passed in is a &quot;unsigned int ndev&quot;
parameter, indicating how many devices to create and call our methods
with.</p>
<p>The platform_driver callbacks are called with a platform_device param;
the isa_driver callbacks are being called with a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*dev,</span>
<span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">id</span></code> pair directly -- with the device creation completely
internal to the bus it's much cleaner to not leak isa_dev's by passing
them in at all. The id is the only thing we ever want other then the
<a class="reference internal" href="infrastructure.html#c.device" title="device"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span></code></a> anyways, and it makes for nicer code in the callbacks as
well.</p>
<p>With this additional .<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">match()</span></code> callback ISA drivers have all options. If
ALSA would want to keep the old non-load behaviour, it could stick all
of the old .probe in .match, which would only keep them registered after
everything was found to be present and accounted for. If it wanted the
behaviour of always loading as it inadvertently did for a bit after the
changeover to platform devices, it could just not provide a .<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">match()</span></code> and
do everything in .<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">probe()</span></code> as before.</p>
<p>If it, as Takashi Iwai already suggested earlier as a way of following
the model from saner buses more closely, wants to load when a later bind
could conceivably succeed, it could use .<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">match()</span></code> for the prerequisites
(such as checking the user wants the card enabled and that port/irq/dma
values have been passed in) and .<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">probe()</span></code> for everything else. This is
the nicest model.</p>
<p>To the code...</p>
<p>This exports only two functions; isa_{,un}<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">register_driver()</span></code>.</p>
<p><code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">isa_register_driver()</span></code> register's the <a class="reference internal" href="infrastructure.html#c.device_driver" title="device_driver"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device_driver</span></code></a>, and then
loops over the passed in ndev creating devices and registering them.
This causes the bus match method to be called for them, which is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int isa_bus_match(struct device *dev, struct device_driver *driver)
{
        struct isa_driver *isa_driver = to_isa_driver(driver);

        if (dev-&gt;platform_data == isa_driver) {
                if (!isa_driver-&gt;match ||
                        isa_driver-&gt;match(dev, to_isa_dev(dev)-&gt;id))
                        return 1;
                dev-&gt;platform_data = NULL;
        }
        return 0;
}
</pre></div>
</div>
<p>The first thing this does is check if this device is in fact one of this
driver's devices by seeing if the device's platform_data pointer is set
to this driver. Platform devices compare strings, but we don't need to
do that with everything being internal, so <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">isa_register_driver()</span></code> abuses
dev-&gt;platform_data as a isa_driver pointer which we can then check here.
I believe platform_data is available for this, but if rather not, moving
the isa_driver pointer to the private <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span> <span class="pre">isa_dev</span></code> is ofcourse fine as
well.</p>
<p>Then, if the driver did not provide a .match, it matches. If it did,
the driver <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">match()</span></code> method is called to determine a match.</p>
<p>If it did <strong>not</strong> match, dev-&gt;platform_data is reset to indicate this to
isa_register_driver which can then unregister the device again.</p>
<p>If during all this, there's any error, or no devices matched at all
everything is backed out again and the error, or -ENODEV, is returned.</p>
<p><code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">isa_unregister_driver()</span></code> just unregisters the matched devices and the
driver itself.</p>
<p>module_isa_driver is a helper macro for ISA drivers which do not do
anything special in module init/exit. This eliminates a lot of
boilerplate code. Each module may only use this macro once, and calling
it replaces module_init and module_exit.</p>
<p>max_num_isa_dev is a macro to determine the maximum possible number of
ISA devices which may be registered in the I/O port address space given
the address extent of the ISA devices.</p>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/driver-api/isa.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>