<!DOCTYPE html>

<html lang="zh-TW" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>The io_mapping functions &#8212; The Linux Kernel  說明文件</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=adfc0c0d" />
    <script src="../_static/documentation_options.js?v=0d9984b1"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/driver-api/io-mapping.html" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜尋" href="../search.html" />
    <link rel="next" title="Ordering I/O writes to memory-mapped addresses" href="io_ordering.html" />
    <link rel="prev" title="Component Helper for Aggregate Drivers" href="component.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.18.0-rc2</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜尋</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="前往" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">提交補釘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">行為守則</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">維護者手冊</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">核心 API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Driver APIs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#general-information-for-driver-authors">General information for driver authors</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#useful-support-libraries">Useful support libraries</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="early-userspace/index.html">Early Userspace</a></li>
<li class="toctree-l3"><a class="reference internal" href="connector.html">Kernel Connector</a></li>
<li class="toctree-l3"><a class="reference internal" href="device-io.html">Bus-Independent Device Accesses</a></li>
<li class="toctree-l3"><a class="reference internal" href="devfreq.html">Device Frequency Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="dma-buf.html">Buffer Sharing and Synchronization (dma-buf)</a></li>
<li class="toctree-l3"><a class="reference internal" href="component.html">Component Helper for Aggregate Drivers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">The io_mapping functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="io_ordering.html">Ordering I/O writes to memory-mapped addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="uio-howto.html">The Userspace I/O HOWTO</a></li>
<li class="toctree-l3"><a class="reference internal" href="vfio-mediated-device.html">VFIO Mediated devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="vfio.html">VFIO - &quot;Virtual Function I/O&quot; </a></li>
<li class="toctree-l3"><a class="reference internal" href="vfio-pci-device-specific-driver-acceptance.html">Acceptance criteria for vfio-pci device specific driver variants</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#bus-level-documentation">Bus-level documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#subsystem-specific-apis">Subsystem-specific APIs</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">子系統</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#core-subsystems">Core subsystems</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../core-api/index.html">核心 API 文件</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Driver implementer's API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mm/index.html">記憶體管理文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../power/index.html">電源管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scheduler/index.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../timers/index.html">計時器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">撰寫文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">開發工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">測試指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">建置系統</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">回報議題</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">使用者空間工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">使用者空間 API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">韌體</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">韌體與裝置樹</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU 架構</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">未排序的文件</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本頁</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/driver-api/io-mapping.rst.txt"
            rel="nofollow">顯示原始碼</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="the-io-mapping-functions">
<h1>The io_mapping functions<a class="headerlink" href="#the-io-mapping-functions" title="連結到這個標頭">¶</a></h1>
<section id="api">
<h2>API<a class="headerlink" href="#api" title="連結到這個標頭">¶</a></h2>
<p>The io_mapping functions in linux/io-mapping.h provide an abstraction for
efficiently mapping small regions of an I/O device to the CPU. The initial
usage is to support the large graphics aperture on 32-bit processors where
ioremap_wc cannot be used to statically map the entire aperture to the CPU
as it would consume too much of the kernel address space.</p>
<p>A mapping object is created during driver initialization using:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct io_mapping *io_mapping_create_wc(unsigned long base,
                                        unsigned long size)
</pre></div>
</div>
<p>'base' is the bus address of the region to be made
mappable, while 'size' indicates how large a mapping region to
enable. Both are in bytes.</p>
<p>This _wc variant provides a mapping which may only be used with
<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_atomic_wc()</span></code>, <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_local_wc()</span></code> or
<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_wc()</span></code>.</p>
<p>With this mapping object, individual pages can be mapped either temporarily
or long term, depending on the requirements. Of course, temporary maps are
more efficient. They come in two flavours:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void *io_mapping_map_local_wc(struct io_mapping *mapping,
                              unsigned long offset)

void *io_mapping_map_atomic_wc(struct io_mapping *mapping,
                               unsigned long offset)
</pre></div>
</div>
<p>'offset' is the offset within the defined mapping region.  Accessing
addresses beyond the region specified in the creation function yields
undefined results. Using an offset which is not page aligned yields an
undefined result. The return value points to a single page in CPU address
space.</p>
<p>This _wc variant returns a write-combining map to the page and may only be
used with mappings created by <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_create_wc()</span></code></p>
<p>Temporary mappings are only valid in the context of the caller. The mapping
is not guaranteed to be globally visible.</p>
<p><code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_local_wc()</span></code> has a side effect on X86 32bit as it disables
migration to make the mapping code work. No caller can rely on this side
effect.</p>
<p><code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_atomic_wc()</span></code> has the side effect of disabling preemption and
pagefaults. Don't use in new code. Use <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_local_wc()</span></code> instead.</p>
<p>Nested mappings need to be undone in reverse order because the mapping
code uses a stack for keeping track of them:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>addr1 = io_mapping_map_local_wc(map1, offset1);
addr2 = io_mapping_map_local_wc(map2, offset2);
...
io_mapping_unmap_local(addr2);
io_mapping_unmap_local(addr1);
</pre></div>
</div>
<p>The mappings are released with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void io_mapping_unmap_local(void *vaddr)
void io_mapping_unmap_atomic(void *vaddr)
</pre></div>
</div>
<p>'vaddr' must be the value returned by the last <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_local_wc()</span></code> or
<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_atomic_wc()</span></code> call. This unmaps the specified mapping and
undoes the side effects of the mapping functions.</p>
<p>If you need to sleep while holding a mapping, you can use the regular
variant, although this may be significantly slower:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void *io_mapping_map_wc(struct io_mapping *mapping,
                        unsigned long offset)
</pre></div>
</div>
<p>This works like io_mapping_map_atomic/<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">local_wc()</span></code> except it has no side
effects and the pointer is globally visible.</p>
<p>The mappings are released with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void io_mapping_unmap(void *vaddr)
</pre></div>
</div>
<p>Use for pages mapped with <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">io_mapping_map_wc()</span></code>.</p>
<p>At driver close time, the io_mapping object must be freed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void io_mapping_free(struct io_mapping *mapping)
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/driver-api/io-mapping.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>