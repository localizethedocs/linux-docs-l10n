<!DOCTYPE html>

<html lang="en-US" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>NFSD IO MODES &#8212; The Linux Kernel unknown version documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=750ed68d"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/filesystems/nfs/nfsd-io-modes.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Kernel NFS Server Statistics" href="knfsd-stats.html" />
    <link rel="prev" title="NFSv4.1 Server Implementation" href="nfs41-server.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../subsystem-apis.html#storage-interfaces">Storage interfaces</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cdrom/index.html">CD-ROM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../scsi/index.html">SCSI Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../nvme/index.html">NVMe Subsystem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/filesystems/nfs/nfsd-io-modes.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="nfsd-io-modes">
<h1>NFSD IO MODES<a class="headerlink" href="#nfsd-io-modes" title="Link to this heading">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>NFSD has historically always used buffered IO when servicing READ and
WRITE operations. BUFFERED is NFSD’s default IO mode, but it is possible
to override that default to use either DONTCACHE or DIRECT IO modes.</p>
<p>Experimental NFSD debugfs interfaces are available to allow the NFSD IO
mode used for READ and WRITE to be configured independently. See both:</p>
<ul class="simple">
<li><p>/sys/kernel/debug/nfsd/io_cache_read</p></li>
<li><p>/sys/kernel/debug/nfsd/io_cache_write</p></li>
</ul>
<p>The default value for both io_cache_read and io_cache_write reflects
NFSD’s default IO mode (which is NFSD_IO_BUFFERED=0).</p>
<p>Based on the configured settings, NFSD’s IO will either be:</p>
<ul class="simple">
<li><p>cached using page cache (NFSD_IO_BUFFERED=0)</p></li>
<li><p>cached but removed from page cache on completion (NFSD_IO_DONTCACHE=1)</p></li>
<li><p>not cached stable_how=NFS_UNSTABLE (NFSD_IO_DIRECT=2)</p></li>
</ul>
<p>To set an NFSD IO mode, write a supported value (0 - 2) to the
corresponding IO operation’s debugfs interface, e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 2 &gt; /sys/kernel/debug/nfsd/io_cache_read
echo 2 &gt; /sys/kernel/debug/nfsd/io_cache_write
</pre></div>
</div>
<p>To check which IO mode NFSD is using for READ or WRITE, simply read the
corresponding IO operation’s debugfs interface, e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /sys/kernel/debug/nfsd/io_cache_read
cat /sys/kernel/debug/nfsd/io_cache_write
</pre></div>
</div>
<p>If you experiment with NFSD’s IO modes on a recent kernel and have
interesting results, please report them to <a class="reference external" href="mailto:linux-nfs&#37;&#52;&#48;vger&#46;kernel&#46;org">linux-nfs<span>&#64;</span>vger<span>&#46;</span>kernel<span>&#46;</span>org</a></p>
</section>
<section id="nfsd-dontcache">
<h2>NFSD DONTCACHE<a class="headerlink" href="#nfsd-dontcache" title="Link to this heading">¶</a></h2>
<p>DONTCACHE offers a hybrid approach to servicing IO that aims to offer
the benefits of using DIRECT IO without any of the strict alignment
requirements that DIRECT IO imposes. To achieve this buffered IO is used
but the IO is flagged to “drop behind” (meaning associated pages are
dropped from the page cache) when IO completes.</p>
<p>DONTCACHE aims to avoid what has proven to be a fairly significant
limition of Linux’s memory management subsystem if/when large amounts of
data is infrequently accessed (e.g. read once _or_ written once but not
read until much later). Such use-cases are particularly problematic
because the page cache will eventually become a bottleneck to servicing
new IO requests.</p>
<p>For more context on DONTCACHE, please see these Linux commit headers:</p>
<ul class="simple">
<li><p>Overview:  9ad6344568cc3 (“mm/filemap: change <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">filemap_create_folio()</span></code>
to take a <code class="xref c c-struct broken_xref docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kiocb</span></code>”)</p></li>
<li><p>for READ:  8026e49bff9b1 (“mm/filemap: add read support for
RWF_DONTCACHE”)</p></li>
<li><p>for WRITE: 974c5e6139db3 (“xfs: flag as supporting FOP_DONTCACHE”)</p></li>
</ul>
<p>NFSD_IO_DONTCACHE will fall back to NFSD_IO_BUFFERED if the underlying
filesystem doesn’t indicate support by setting FOP_DONTCACHE.</p>
</section>
<section id="nfsd-direct">
<h2>NFSD DIRECT<a class="headerlink" href="#nfsd-direct" title="Link to this heading">¶</a></h2>
<p>DIRECT IO doesn’t make use of the page cache, as such it is able to
avoid the Linux memory management’s page reclaim scalability problems
without resorting to the hybrid use of page cache that DONTCACHE does.</p>
<p>Some workloads benefit from NFSD avoiding the page cache, particularly
those with a working set that is significantly larger than available
system memory. The pathological worst-case workload that NFSD DIRECT has
proven to help most is: NFS client issuing large sequential IO to a file
that is 2-3 times larger than the NFS server’s available system memory.
The reason for such improvement is NFSD DIRECT eliminates a lot of work
that the memory management subsystem would otherwise be required to
perform (e.g. page allocation, dirty writeback, page reclaim). When
using NFSD DIRECT, kswapd and kcompactd are no longer commanding CPU
time trying to find adequate free pages so that forward IO progress can
be made.</p>
<p>The performance win associated with using NFSD DIRECT was previously
discussed on linux-nfs, see:
<a class="reference external" href="https://lore.kernel.org/linux-nfs/aEslwqa9iMeZjjlV&#64;kernel.org/">https://lore.kernel.org/linux-nfs/aEslwqa9iMeZjjlV&#64;kernel.org/</a></p>
<p>But in summary:</p>
<ul class="simple">
<li><p>NFSD DIRECT can significantly reduce memory requirements</p></li>
<li><p>NFSD DIRECT can reduce CPU load by avoiding costly page reclaim work</p></li>
<li><p>NFSD DIRECT can offer more deterministic IO performance</p></li>
</ul>
<p>As always, your mileage may vary and so it is important to carefully
consider if/when it is beneficial to make use of NFSD DIRECT. When
assessing comparative performance of your workload please be sure to log
relevant performance metrics during testing (e.g. memory usage, cpu
usage, IO performance). Using perf to collect perf data that may be used
to generate a “flamegraph” for work Linux must perform on behalf of your
test is a really meaningful way to compare the relative health of the
system and how switching NFSD’s IO mode changes what is observed.</p>
<p>If NFSD_IO_DIRECT is specified by writing 2 (or 3 and 4 for WRITE) to
NFSD’s debugfs interfaces, ideally the IO will be aligned relative to
the underlying block device’s logical_block_size. Also the memory buffer
used to store the READ or WRITE payload must be aligned relative to the
underlying block device’s dma_alignment.</p>
<p>But NFSD DIRECT does handle misaligned IO in terms of O_DIRECT as best
it can:</p>
<dl>
<dt>Misaligned READ:</dt><dd><p>If NFSD_IO_DIRECT is used, expand any misaligned READ to the next
DIO-aligned block (on either end of the READ). The expanded READ is
verified to have proper offset/len (logical_block_size) and
dma_alignment checking.</p>
</dd>
<dt>Misaligned WRITE:</dt><dd><p>If NFSD_IO_DIRECT is used, split any misaligned WRITE into a start,
middle and end as needed. The large middle segment is DIO-aligned
and the start and/or end are misaligned. Buffered IO is used for the
misaligned segments and O_DIRECT is used for the middle DIO-aligned
segment. DONTCACHE buffered IO is _not_ used for the misaligned
segments because using normal buffered IO offers significant RMW
performance benefit when handling streaming misaligned WRITEs.</p>
</dd>
<dt>Tracing:</dt><dd><p>The nfsd_read_direct trace event shows how NFSD expands any
misaligned READ to the next DIO-aligned block (on either end of the
original READ, as needed).</p>
<p>This combination of trace events is useful for READs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 1 &gt; /sys/kernel/tracing/events/nfsd/nfsd_read_vector/enable
echo 1 &gt; /sys/kernel/tracing/events/nfsd/nfsd_read_direct/enable
echo 1 &gt; /sys/kernel/tracing/events/nfsd/nfsd_read_io_done/enable
echo 1 &gt; /sys/kernel/tracing/events/xfs/xfs_file_direct_read/enable
</pre></div>
</div>
<p>The nfsd_write_direct trace event shows how NFSD splits a given
misaligned WRITE into a DIO-aligned middle segment.</p>
<p>This combination of trace events is useful for WRITEs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 1 &gt; /sys/kernel/tracing/events/nfsd/nfsd_write_opened/enable
echo 1 &gt; /sys/kernel/tracing/events/nfsd/nfsd_write_direct/enable
echo 1 &gt; /sys/kernel/tracing/events/nfsd/nfsd_write_io_done/enable
echo 1 &gt; /sys/kernel/tracing/events/xfs/xfs_file_direct_write/enable
</pre></div>
</div>
</dd>
</dl>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/filesystems/nfs/nfsd-io-modes.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>