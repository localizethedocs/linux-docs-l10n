<!DOCTYPE html>

<html lang="en-US" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Porting an architecture to support PREEMPT_RT &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=ccd1e645"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/core-api/real-time/architecture-porting.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Everything you never wanted to know about kobjects, ksets, and ktypes" href="../kobject.html" />
    <link rel="prev" title="How realtime kernels differ" href="differences.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.18.0-rc2</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Core API</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#core-utilities">Core utilities</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../kernel-api.html">The Linux Kernel API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../workqueue.html">Workqueue</a></li>
<li class="toctree-l3"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../printk-basics.html">Message logging with printk</a></li>
<li class="toctree-l3"><a class="reference internal" href="../printk-formats.html">How to get printk format specifiers right</a></li>
<li class="toctree-l3"><a class="reference internal" href="../printk-index.html">Printk Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="../symbol-namespaces.html">Symbol Namespaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Real-time preemption</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#data-structures-and-low-level-utilities">Data structures and low-level utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#low-level-entry-and-exit">Low level entry and exit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#concurrency-primitives">Concurrency primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#low-level-hardware-management">Low-level hardware management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#memory-management">Memory management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#interfaces-for-kernel-debugging">Interfaces for kernel debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#everything-else">Everything else</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../subsystem-apis.html#core-subsystems">Core subsystems</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Core API Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../driver-api/index.html">Driver implementer’s API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mm/index.html">Memory Management Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../scheduler/index.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../timers/index.html">Timers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/core-api/real-time/architecture-porting.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="porting-an-architecture-to-support-preempt-rt">
<h1>Porting an architecture to support PREEMPT_RT<a class="headerlink" href="#porting-an-architecture-to-support-preempt-rt" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Sebastian Andrzej Siewior &lt;<a class="reference external" href="mailto:bigeasy&#37;&#52;&#48;linutronix&#46;de">bigeasy<span>&#64;</span>linutronix<span>&#46;</span>de</a>&gt;</p>
</dd>
</dl>
<p>This list outlines the architecture specific requirements that must be
implemented in order to enable PREEMPT_RT. Once all required features are
implemented, ARCH_SUPPORTS_RT can be selected in architecture’s Kconfig to make
PREEMPT_RT selectable.
Many prerequisites (genirq support for example) are enforced by the common code
and are omitted here.</p>
<p>The optional features are not strictly required but it is worth to consider
them.</p>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Link to this heading">¶</a></h2>
<dl class="simple">
<dt>Forced threaded interrupts</dt><dd><p>CONFIG_IRQ_FORCED_THREADING must be selected. Any interrupts that must
remain in hard-IRQ context must be marked with IRQF_NO_THREAD. This
requirement applies for instance to clocksource event interrupts,
perf interrupts and cascading interrupt-controller handlers.</p>
</dd>
<dt>PREEMPTION support</dt><dd><p>Kernel preemption must be supported and requires that
CONFIG_ARCH_NO_PREEMPT remain unselected. Scheduling requests, such as those
issued from an interrupt or other exception handler, must be processed
immediately.</p>
</dd>
<dt>POSIX CPU timers and KVM</dt><dd><p>POSIX CPU timers must expire from thread context rather than directly within
the timer interrupt. This behavior is enabled by setting the configuration
option CONFIG_HAVE_POSIX_CPU_TIMERS_TASK_WORK.
When KVM is enabled, CONFIG_KVM_XFER_TO_GUEST_WORK must also be set to ensure
that any pending work, such as POSIX timer expiration, is handled before
transitioning into guest mode.</p>
</dd>
<dt>Hard-IRQ and Soft-IRQ stacks</dt><dd><p>Soft interrupts are handled in the thread context in which they are raised. If
a soft interrupt is triggered from hard-IRQ context, its execution is deferred
to the ksoftirqd thread. Preemption is never disabled during soft interrupt
handling, which makes soft interrupts preemptible.
If an architecture provides a custom <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">__do_softirq()</span></code> implementation that uses a
separate stack, it must select CONFIG_HAVE_SOFTIRQ_ON_OWN_STACK. The
functionality should only be enabled when CONFIG_SOFTIRQ_ON_OWN_STACK is set.</p>
</dd>
<dt>FPU and SIMD access in kernel mode</dt><dd><p>FPU and SIMD registers are typically not used in kernel mode and are therefore
not saved during kernel preemption. As a result, any kernel code that uses
these registers must be enclosed within a <a class="reference internal" href="../floating-point.html#c.kernel_fpu_begin" title="kernel_fpu_begin"><code class="xref c c-func docutils literal notranslate"><span class="pre">kernel_fpu_begin()</span></code></a> and
<a class="reference internal" href="../floating-point.html#c.kernel_fpu_end" title="kernel_fpu_end"><code class="xref c c-func docutils literal notranslate"><span class="pre">kernel_fpu_end()</span></code></a> section.
The <a class="reference internal" href="../floating-point.html#c.kernel_fpu_begin" title="kernel_fpu_begin"><code class="xref c c-func docutils literal notranslate"><span class="pre">kernel_fpu_begin()</span></code></a> function usually invokes <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">local_bh_disable()</span></code> to prevent
interruptions from softirqs and to disable regular preemption. This allows the
protected code to run safely in both thread and softirq contexts.
On PREEMPT_RT kernels, however, <a class="reference internal" href="../floating-point.html#c.kernel_fpu_begin" title="kernel_fpu_begin"><code class="xref c c-func docutils literal notranslate"><span class="pre">kernel_fpu_begin()</span></code></a> must not call
<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">local_bh_disable()</span></code>. Instead, it should use <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">preempt_disable()</span></code>, since softirqs
are always handled in thread context under PREEMPT_RT. In this case, disabling
preemption alone is sufficient.
The crypto subsystem operates on memory pages and requires users to “walk and
map” these pages while processing a request. This operation must occur outside
the <a class="reference internal" href="../floating-point.html#c.kernel_fpu_begin" title="kernel_fpu_begin"><code class="xref c c-func docutils literal notranslate"><span class="pre">kernel_fpu_begin()</span></code></a>/ <a class="reference internal" href="../floating-point.html#c.kernel_fpu_end" title="kernel_fpu_end"><code class="xref c c-func docutils literal notranslate"><span class="pre">kernel_fpu_end()</span></code></a> section because it requires preemption
to be enabled. These preemption points are generally sufficient to avoid
excessive scheduling latency.</p>
</dd>
<dt>Exception handlers</dt><dd><p>Exception handlers, such as the page fault handler, typically enable interrupts
early, before invoking any generic code to process the exception. This is
necessary because handling a page fault may involve operations that can sleep.
Enabling interrupts is especially important on PREEMPT_RT, where certain
locks, such as spinlock_t, become sleepable. For example, handling an
invalid opcode may result in sending a SIGILL signal to the user task. A
debug excpetion will send a SIGTRAP signal.
In both cases, if the exception occurred in user space, it is safe to enable
interrupts early. Sending a signal requires both interrupts and kernel
preemption to be enabled.</p>
</dd>
</dl>
</section>
<section id="optional-features">
<h2>Optional features<a class="headerlink" href="#optional-features" title="Link to this heading">¶</a></h2>
<dl class="simple">
<dt>Timer and clocksource</dt><dd><p>A high-resolution clocksource and clockevents device are recommended. The
clockevents device should support the CLOCK_EVT_FEAT_ONESHOT feature for
optimal timer behavior. In most cases, microsecond-level accuracy is
sufficient</p>
</dd>
<dt>Lazy preemption</dt><dd><p>This mechanism allows an in-kernel scheduling request for non-real-time tasks
to be delayed until the task is about to return to user space. It helps avoid
preempting a task that holds a sleeping lock at the time of the scheduling
request.
With CONFIG_GENERIC_IRQ_ENTRY enabled, supporting this feature requires
defining a bit for TIF_NEED_RESCHED_LAZY, preferably near TIF_NEED_RESCHED.</p>
</dd>
<dt>Serial console with NBCON</dt><dd><p>With PREEMPT_RT enabled, all console output is handled by a dedicated thread
rather than directly from the context in which <a class="reference internal" href="../printk-basics.html#c.printk" title="printk"><code class="xref c c-func docutils literal notranslate"><span class="pre">printk()</span></code></a> is invoked. This design
allows <a class="reference internal" href="../printk-basics.html#c.printk" title="printk"><code class="xref c c-func docutils literal notranslate"><span class="pre">printk()</span></code></a> to be safely used in atomic contexts.
However, this also means that if the kernel crashes and cannot switch to the
printing thread, no output will be visible preventing the system from printing
its final messages.
There are exceptions for immediate output, such as during <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">panic()</span></code> handling. To
support this, the console driver must implement new-style lock handling. This
involves setting the CON_NBCON flag in console::flags and providing
implementations for the write_atomic, write_thread, device_lock, and
device_unlock callbacks.</p>
</dd>
</dl>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/core-api/real-time/architecture-porting.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>