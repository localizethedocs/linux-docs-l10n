<!DOCTYPE html>

<html lang="en-US" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>7.11. ARM Mali-C55 Image Signal Processor driver &#8212; The Linux Kernel unknown version documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=750ed68d"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/admin-guide/media/mali-c55.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="7.12. The mgb4 driver" href="mgb4.html" />
    <link rel="prev" title="7.10. The ivtv driver" href="ivtv.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Administration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#general-guides-to-kernel-administration">General guides to kernel administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#booting-the-kernel">Booting the kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tracking-down-and-identifying-problems">Tracking down and identifying problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#core-kernel-subsystems">Core-kernel subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#block-layer-and-filesystem-administration">Block-layer and filesystem administration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#device-specific-guides">Device-specific guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../acpi/index.html">ACPI Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aoe/index.html">ATA over Ethernet (AoE)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auxdisplay/index.html">Auxiliary Display Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../braille-console.html">Linux Braille Console</a></li>
<li class="toctree-l3"><a class="reference internal" href="../btmrvl.html">btmrvl driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dell_rbu.html">Dell Remote BIOS Update driver (dell_rbu)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../edid.html">EDID</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gpio/index.html">GPIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hw_random.html">Hardware random number generators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../laptops/index.html">Laptop Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lcd-panel-cgram.html">Parallel port LCD/Keypad Panel support</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Media subsystem admin and user guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvme-multipath.html">Linux NVMe multipath</a></li>
<li class="toctree-l3"><a class="reference internal" href="../parport.html">Parport</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pnp.html">Linux Plug and Play Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rapidio.html">RapidIO Subsystem Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rtc.html">Real Time Clock (RTC) Drivers for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../serial-console.html">Linux Serial Console</a></li>
<li class="toctree-l3"><a class="reference internal" href="../svga.html">Video Mode Selection Support 2.13</a></li>
<li class="toctree-l3"><a class="reference internal" href="../thermal/index.html">Thermal Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../thunderbolt.html">USB4 and Thunderbolt</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vga-softcursor.html">Software cursor for VGA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../video-output.html">Video Output Switcher Control</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#workload-analysis">Workload analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#everything-else">Everything else</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/media/mali-c55.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="arm-mali-c55-image-signal-processor-driver">
<h1><span class="section-number">7.11. </span>ARM Mali-C55 Image Signal Processor driver<a class="headerlink" href="#arm-mali-c55-image-signal-processor-driver" title="Link to this heading">¶</a></h1>
<section id="introduction">
<h2><span class="section-number">7.11.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>This file documents the driver for ARM’s Mali-C55 Image Signal Processor. The
driver is located under drivers/media/platform/arm/mali-c55.</p>
<p>The Mali-C55 ISP receives data in either raw Bayer format or RGB/YUV format from
sensors through either a parallel interface or a memory bus before processing it
and outputting it through an internal DMA engine. Two output pipelines are
possible (though one may not be fitted, depending on the implementation). These
are referred to as “Full resolution” and “Downscale”, but the naming is historic
and both pipes are capable of cropping/scaling operations. The full resolution
pipe is also capable of outputting RAW data, bypassing much of the ISP’s
processing. The downscale pipe cannot output RAW data. An integrated test
pattern generator can be used to drive the ISP and produce image data in the
absence of a connected camera sensor. The driver module is named mali_c55, and
is enabled through the CONFIG_VIDEO_MALI_C55 config option.</p>
<p>The driver implements V4L2, Media Controller and V4L2 Subdevice interfaces and
expects camera sensors connected to the ISP to have V4L2 subdevice interfaces.</p>
</section>
<section id="mali-c55-isp-hardware">
<h2><span class="section-number">7.11.2. </span>Mali-C55 ISP hardware<a class="headerlink" href="#mali-c55-isp-hardware" title="Link to this heading">¶</a></h2>
<p>A high level functional view of the Mali-C55 ISP is presented below. The ISP
takes input from either a live source or through a DMA engine for memory input,
depending on the SoC integration.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------+    +----------+                                     +--------+
| Sensor  |---&gt;| CSI-2 Rx |                &quot;Full Resolution&quot;    |  DMA   |
+---------+    +----------+   |\                 Output    +---&gt;| Writer |
                     |        | \                          |    +--------+
                     |        |  \    +----------+  +------+---&gt; Streaming I/O
+------------+       +-------&gt;|   |   |          |  |
|            |                |   |--&gt;| Mali-C55 |--+
| DMA Reader |---------------&gt;|   |   |    ISP   |  |
|            |                |  /    |          |  |      +---&gt; Streaming I/O
+------------+                | /     +----------+  |      |
                              |/                    +------+
                                                           |    +--------+
                                                           +---&gt;|  DMA   |
                                             &quot;Downscaled&quot;       | Writer |
                                                Output          +--------+
</pre></div>
</div>
</section>
<section id="media-controller-topology">
<h2><span class="section-number">7.11.3. </span>Media Controller Topology<a class="headerlink" href="#media-controller-topology" title="Link to this heading">¶</a></h2>
<p>An example of the ISP’s topology (as implemented in a system with an IMX415
camera sensor and generic CSI-2 receiver) is below:</p>
<figure class="align-center">
<img alt="mali-c55-graph.dot" src="../../_images/mali-c55-graph.svg" />
</figure>
<p>The driver has 4 V4L2 subdevices:</p>
<ul class="simple">
<li><dl class="simple">
<dt><cite>mali_c55 isp</cite>: Responsible for configuring input crop and color space</dt><dd><p>conversion</p>
</dd>
</dl>
</li>
<li><p><cite>mali_c55 tpg</cite>: The test pattern generator, emulating a camera sensor.</p></li>
<li><p><cite>mali_c55 resizer fr</cite>: The Full-Resolution pipe resizer</p></li>
<li><p><cite>mali_c55 resizer ds</cite>: The Downscale pipe resizer</p></li>
</ul>
<p>The driver has 3 V4L2 video devices:</p>
<ul class="simple">
<li><p><cite>mali-c55 fr</cite>: The full-resolution pipe’s capture device</p></li>
<li><p><cite>mali-c55 ds</cite>: The downscale pipe’s capture device</p></li>
<li><p><cite>mali-c55 3a stats</cite>: The 3A statistics capture device</p></li>
</ul>
<p>Frame sequences are synchronised across to two capture devices, meaning if one
pipe is started later than the other the sequence numbers returned in its
buffers will match those of the other pipe rather than starting from zero.</p>
<section id="idiosyncrasies">
<h3><span class="section-number">7.11.3.1. </span>Idiosyncrasies<a class="headerlink" href="#idiosyncrasies" title="Link to this heading">¶</a></h3>
<p><strong>mali-c55 isp</strong>
The <cite>mali-c55 isp</cite> subdevice has a single sink pad to which all sources of data
should be connected. The active source is selected by enabling the appropriate
media link and disabling all others. The ISP has two source pads, reflecting the
different paths through which it can internally route data. Tap points within
the ISP allow users to divert data to avoid processing by some or all of the
hardware’s processing steps. The diagram below is intended only to highlight how
the bypassing works and is not a true reflection of those processing steps; for
a high-level functional block diagram see ARM’s developer page for the
ISP <a class="footnote-reference brackets" href="#id6" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------------------------------------------------------------+
|                Possible Internal ISP Data Routes             |
|          +------------+  +----------+  +------------+        |
+---+      |            |  |          |  |  Colour    |    +---+
| 0 |--+--&gt;| Processing |-&gt;| Demosaic |-&gt;|   Space    |---&gt;| 1 |
+---+  |   |            |  |          |  | Conversion |    +---+
|      |   +------------+  +----------+  +------------+        |
|      |                                                   +---+
|      +---------------------------------------------------| 2 |
|                                                          +---+
|                                                              |
+--------------------------------------------------------------+
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Pad</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>sink</p></td>
<td><p>Data input, connected to the TPG and camera sensors</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>source</p></td>
<td><p>RGB/YUV data, connected to the FR and DS V4L2 subdevices</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>source</p></td>
<td><p>RAW bayer data, connected to the FR V4L2 subdevices</p></td>
</tr>
</tbody>
</table>
<p>The ISP is limited to both input and output resolutions between 640x480 and
8192x8192, and this is reflected in the ISP and resizer subdevice’s .<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">set_fmt()</span></code>
operations.</p>
<p><strong>mali-c55 resizer fr</strong>
The <cite>mali-c55 resizer fr</cite> subdevice has two _sink_ pads to reflect the different
insertion points in the hardware (either RAW or demosaiced data):</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Pad</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>sink</p></td>
<td><p>Data input connected to the ISP’s demosaiced stream.</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>source</p></td>
<td><p>Data output connected to the capture video device</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>sink</p></td>
<td><p>Data input connected to the ISP’s raw data stream</p></td>
</tr>
</tbody>
</table>
<p>The data source in use is selected through the routing API; two routes each of a
single stream are available:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Sink Pad</p></th>
<th class="head"><p>Source Pad</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>Demosaiced data route</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>1</p></td>
<td><p>Raw data route</p></td>
</tr>
</tbody>
</table>
<p>If the demosaiced route is active then the FR pipe is only capable of output
in RGB/YUV formats. If the raw route is active then the output reflects the
input (which may be either Bayer or RGB/YUV data).</p>
</section>
</section>
<section id="using-the-driver-to-capture-video">
<h2><span class="section-number">7.11.4. </span>Using the driver to capture video<a class="headerlink" href="#using-the-driver-to-capture-video" title="Link to this heading">¶</a></h2>
<p>Using the media controller APIs we can configure the input source and ISP to
capture images in a variety of formats. In the examples below, configuring the
media graph is done with the v4l-utils <a class="footnote-reference brackets" href="#id4" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> package’s media-ctl utility.
Capturing the images is done with yavta <a class="footnote-reference brackets" href="#id5" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<section id="configuring-the-input-source">
<h3><span class="section-number">7.11.4.1. </span>Configuring the input source<a class="headerlink" href="#configuring-the-input-source" title="Link to this heading">¶</a></h3>
<p>The first step is to set the input source that we wish by enabling the correct
media link. Using the example topology above, we can select the TPG as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>media-ctl -l &quot;&#39;lte-csi2-rx&#39;:1-&gt;&#39;mali-c55 isp&#39;:0[0]&quot;
media-ctl -l &quot;&#39;mali-c55 tpg&#39;:0-&gt;&#39;mali-c55 isp&#39;:0[1]&quot;
</pre></div>
</div>
</section>
<section id="configuring-which-video-devices-will-stream-data">
<h3><span class="section-number">7.11.4.2. </span>Configuring which video devices will stream data<a class="headerlink" href="#configuring-which-video-devices-will-stream-data" title="Link to this heading">¶</a></h3>
<p>The driver will wait for all video devices to have their VIDIOC_STREAMON ioctl
called before it tells the sensor to start streaming. To facilitate this we need
to enable links to the video devices that we want to use. In the example below
we enable the links to both of the image capture video devices</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>media-ctl -l &quot;&#39;mali-c55 resizer fr&#39;:1-&gt;&#39;mali-c55 fr&#39;:0[1]&quot;
media-ctl -l &quot;&#39;mali-c55 resizer ds&#39;:1-&gt;&#39;mali-c55 ds&#39;:0[1]&quot;
</pre></div>
</div>
</section>
<section id="capturing-bayer-data-from-the-source-and-processing-to-rgb-yuv">
<h3><span class="section-number">7.11.4.3. </span>Capturing bayer data from the source and processing to RGB/YUV<a class="headerlink" href="#capturing-bayer-data-from-the-source-and-processing-to-rgb-yuv" title="Link to this heading">¶</a></h3>
<p>To capture 1920x1080 bayer data from the source and push it through the ISP’s
full processing pipeline, we configure the data formats appropriately on the
source, ISP and resizer subdevices and set the FR resizer’s routing to select
processed data. The media bus format on the resizer’s source pad will be either
RGB121212_1X36 or YUV10_1X30, depending on whether you want to capture RGB or
YUV. The ISP’s debayering block outputs RGB data natively, setting the source
pad format to YUV10_1X30 enables the colour space conversion block.</p>
<p>In this example we target RGB565 output, so select RGB121212_1X36 as the resizer
source pad’s format:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Set formats on the TPG and ISP
media-ctl -V &quot;&#39;mali-c55 tpg&#39;:0[fmt:SRGGB20_1X20/1920x1080]&quot;
media-ctl -V &quot;&#39;mali-c55 isp&#39;:0[fmt:SRGGB20_1X20/1920x1080]&quot;
media-ctl -V &quot;&#39;mali-c55 isp&#39;:1[fmt:SRGGB20_1X20/1920x1080]&quot;

# Set routing on the FR resizer
media-ctl -R &quot;&#39;mali-c55 resizer fr&#39;[0/0-&gt;1/0[1],2/0-&gt;1/0[0]]&quot;

# Set format on the resizer, must be done AFTER the routing.
media-ctl -V &quot;&#39;mali-c55 resizer fr&#39;:1[fmt:RGB121212_1X36/1920x1080]&quot;
</pre></div>
</div>
<p>The downscale output can also be used to stream data at the same time. In this
case since only processed data can be captured through the downscale output no
routing need be set:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Set format on the resizer
media-ctl -V &quot;&#39;mali-c55 resizer ds&#39;:1[fmt:RGB121212_1X36/1920x1080]&quot;
</pre></div>
</div>
<p>Following which images can be captured from both the FR and DS output’s video
devices (simultaneously, if desired):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>yavta -f RGB565 -s 1920x1080 -c10 /dev/video0
yavta -f RGB565 -s 1920x1080 -c10 /dev/video1
</pre></div>
</div>
<section id="cropping-the-image">
<h4><span class="section-number">7.11.4.3.1. </span>Cropping the image<a class="headerlink" href="#cropping-the-image" title="Link to this heading">¶</a></h4>
<p>Both the full resolution and downscale pipes can crop to a minimum resolution of
640x480. To crop the image simply configure the resizer’s sink pad’s crop and
compose rectangles and set the format on the video device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>media-ctl -V &quot;&#39;mali-c55 resizer fr&#39;:0[fmt:RGB121212_1X36/1920x1080 crop:(480,270)/640x480 compose:(0,0)/640x480]&quot;
media-ctl -V &quot;&#39;mali-c55 resizer fr&#39;:1[fmt:RGB121212_1X36/640x480]&quot;
yavta -f RGB565 -s 640x480 -c10 /dev/video0
</pre></div>
</div>
</section>
<section id="downscaling-the-image">
<h4><span class="section-number">7.11.4.3.2. </span>Downscaling the image<a class="headerlink" href="#downscaling-the-image" title="Link to this heading">¶</a></h4>
<p>Both the full resolution and downscale pipes can downscale the image by up to 8x
provided the minimum 640x480 output resolution is adhered to. For the best image
result the scaling ratio for each direction should be the same. To configure
scaling we use the compose rectangle on the resizer’s sink pad:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>media-ctl -V &quot;&#39;mali-c55 resizer fr&#39;:0[fmt:RGB121212_1X36/1920x1080 crop:(0,0)/1920x1080 compose:(0,0)/640x480]&quot;
media-ctl -V &quot;&#39;mali-c55 resizer fr&#39;:1[fmt:RGB121212_1X36/640x480]&quot;
yavta -f RGB565 -s 640x480 -c10 /dev/video0
</pre></div>
</div>
</section>
<section id="capturing-images-in-yuv-formats">
<h4><span class="section-number">7.11.4.3.3. </span>Capturing images in YUV formats<a class="headerlink" href="#capturing-images-in-yuv-formats" title="Link to this heading">¶</a></h4>
<p>If we need to output YUV data rather than RGB the color space conversion block
needs to be active, which is achieved by setting MEDIA_BUS_FMT_YUV10_1X30 on the
resizer’s source pad. We can then configure a capture format like NV12 (here in
its multi-planar variant)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>media-ctl -V &quot;&#39;mali-c55 resizer fr&#39;:1[fmt:YUV10_1X30/1920x1080]&quot;
yavta -f NV12M -s 1920x1080 -c10 /dev/video0
</pre></div>
</div>
</section>
</section>
<section id="capturing-rgb-data-from-the-source-and-processing-it-with-the-resizers">
<h3><span class="section-number">7.11.4.4. </span>Capturing RGB data from the source and processing it with the resizers<a class="headerlink" href="#capturing-rgb-data-from-the-source-and-processing-it-with-the-resizers" title="Link to this heading">¶</a></h3>
<p>The Mali-C55 ISP can work with sensors capable of outputting RGB data. In this
case although none of the image quality blocks would be used it can still
crop/scale the data in the usual way. For this reason RGB data input to the ISP
still goes through the ISP subdevice’s pad 1 to the resizer.</p>
<p>To achieve this, the ISP’s sink pad’s format is set to
MEDIA_BUS_FMT_RGB202020_1X60 - this reflects the format that data must be in to
work with the ISP. Converting the camera sensor’s output to that format is the
responsibility of external hardware.</p>
<p>In this example we ask the test pattern generator to give us RGB data instead of
bayer.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>media-ctl -V &quot;&#39;mali-c55 tpg&#39;:0[fmt:RGB202020_1X60/1920x1080]&quot;
media-ctl -V &quot;&#39;mali-c55 isp&#39;:0[fmt:RGB202020_1X60/1920x1080]&quot;
</pre></div>
</div>
<p>Cropping or scaling the data can be done in exactly the same way as outlined
earlier.</p>
</section>
<section id="capturing-raw-data-from-the-source-and-outputting-it-unmodified">
<h3><span class="section-number">7.11.4.5. </span>Capturing raw data from the source and outputting it unmodified<a class="headerlink" href="#capturing-raw-data-from-the-source-and-outputting-it-unmodified" title="Link to this heading">¶</a></h3>
<p>The ISP can additionally capture raw data from the source and output it on the
full resolution pipe only, completely unmodified. In this case the downscale
pipe can still process the data normally and be used at the same time.</p>
<p>To configure raw bypass the FR resizer’s subdevice’s routing table needs to be
configured, followed by formats in the appropriate places:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>media-ctl -R &quot;&#39;mali-c55 resizer fr&#39;[0/0-&gt;1/0[0],2/0-&gt;1/0[1]]&quot;
media-ctl -V &quot;&#39;mali-c55 isp&#39;:0[fmt:RGB202020_1X60/1920x1080]&quot;
media-ctl -V &quot;&#39;mali-c55 resizer fr&#39;:2[fmt:RGB202020_1X60/1920x1080]&quot;
media-ctl -V &quot;&#39;mali-c55 resizer fr&#39;:1[fmt:RGB202020_1X60/1920x1080]&quot;

# Set format on the video device and stream
yavta -f RGB565 -s 1920x1080 -c10 /dev/video0
</pre></div>
</div>
</section>
</section>
<section id="capturing-isp-statistics">
<span id="mali-c55-3a-stats"></span><h2><span class="section-number">7.11.5. </span>Capturing ISP Statistics<a class="headerlink" href="#capturing-isp-statistics" title="Link to this heading">¶</a></h2>
<p>The ISP is capable of producing statistics for consumption by image processing
algorithms running in userspace. These statistics can be captured by queueing
buffers to the <cite>mali-c55 3a stats</cite> V4L2 Device whilst the ISP is streaming. Only
the <a class="reference internal" href="../../userspace-api/media/v4l/metafmt-arm-mali-c55.html#v4l2-meta-fmt-mali-c55-stats"><span class="std std-ref">V4L2_META_FMT_MALI_C55_STATS</span></a>
format is supported, so no format-setting need be done:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># We assume the media graph has been configured to support RGB565 capture
# from the mali-c55 fr V4L2 Device, which is at /dev/video0. The statistics
# V4L2 device is at /dev/video3

yavta -f RGB565 -s 1920x1080 -c32 /dev/video0 &amp;&amp; \
yavta -c10 -F /dev/video3
</pre></div>
</div>
<p>The layout of the buffer is described by <a class="reference internal" href="../../userspace-api/media/v4l/metafmt-arm-mali-c55.html#c.mali_c55_stats_buffer" title="mali_c55_stats_buffer"><code class="xref c c-type docutils literal notranslate"><span class="pre">mali_c55_stats_buffer</span></code></a>,
but broadly statistics are generated to support three image processing
algorithms; AEXP (Auto-Exposure), AWB (Auto-White Balance) and AF (Auto-Focus).
These stats can be drawn from various places in the Mali C55 ISP pipeline, known
as “tap points”. This high-level block diagram is intended to explain where in
the processing flow the statistics can be drawn from:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                +--&gt; AEXP-2            +----&gt; AEXP-1          +--&gt; AF-0
                |                      +----&gt; AF-1            |
                |                      |                      |
    +---------+ |   +--------------+   |   +--------------+   |
    |  Input  +-+--&gt;+ Digital Gain +---+--&gt;+ Black Level  +---+---+
    +---------+     +--------------+       +--------------+       |
+-----------------------------------------------------------------+
|
|   +--------------+ +---------+       +----------------+
+--&gt;| Sinter Noise +-+  White  +--+---&gt;|  Lens Shading  +--+---------------+
    |   Reduction  | | Balance |  |    |                |  |               |
    +--------------+ +---------+  |    +----------------+  |               |
                                  +---&gt; AEXP-0 (A)         +--&gt; AEXP-0 (B) |
+--------------------------------------------------------------------------+
|
|   +----------------+      +--------------+  +----------------+
+--&gt;|  Tone mapping  +-+---&gt;| Demosaicing  +-&gt;+ Purple Fringe  +-+-----------+
    |                | |    +--------------+  |   Correction   | |           |
    +----------------+ +-&gt; AEXP-IRIDIX        +----------------+ +---&gt; AWB-0 |
+----------------------------------------------------------------------------+
|                    +-------------+        +-------------+
+-------------------&gt;|   Colour    +---+---&gt;|    Output   |
                     | Correction  |   |    |  Pipelines  |
                     +-------------+   |    +-------------+
                                       +--&gt;  AWB-1
</pre></div>
</div>
<p>By default all statistics are drawn from the 0th tap point for each algorithm;
I.E. AEXP statistics from AEXP-0 (A), AWB statistics from AWB-0 and AF
statistics from AF-0. This is configurable for AEXP and AWB statsistics through
programming the ISP’s parameters.</p>
</section>
<section id="programming-isp-parameters">
<span id="mali-c55-3a-params"></span><h2><span class="section-number">7.11.6. </span>Programming ISP Parameters<a class="headerlink" href="#programming-isp-parameters" title="Link to this heading">¶</a></h2>
<p>The ISP can be programmed with various parameters from userspace to apply to the
hardware before and during video stream. This allows userspace to dynamically
change values such as black level, white balance and lens shading gains and so
on.</p>
<p>The buffer format and how to populate it are described by the
<a class="reference internal" href="../../userspace-api/media/v4l/metafmt-arm-mali-c55.html#v4l2-meta-fmt-mali-c55-params"><span class="std std-ref">V4L2_META_FMT_MALI_C55_PARAMS</span></a> format,
which should be set as the data format for the <cite>mali-c55 3a params</cite> video node.</p>
</section>
<section id="references">
<h2><span class="section-number">7.11.7. </span>References<a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id4" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://git.linuxtv.org/v4l-utils.git/">https://git.linuxtv.org/v4l-utils.git/</a></p>
</aside>
<aside class="footnote brackets" id="id5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://git.ideasonboard.org/yavta.git">https://git.ideasonboard.org/yavta.git</a></p>
</aside>
<aside class="footnote brackets" id="id6" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://developer.arm.com/Processors/Mali-C55">https://developer.arm.com/Processors/Mali-C55</a></p>
</aside>
</aside>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/admin-guide/media/mali-c55.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>