<!DOCTYPE html>

<html lang="zh-CN" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Real-time application monitors &#8212; The Linux Kernel unknown version 文档</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=c459948e"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=beaddf03"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/trace/rv/monitor_rtapp.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="HiSilicon PCIe Tune and Trace device" href="../hisi-ptt.html" />
    <link rel="prev" title="Scheduler monitors" href="monitor_sched.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="提交" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tracing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#introduction-to-tracing">Introduction to Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#core-tracing-frameworks">Core Tracing Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#event-tracing-and-analysis">Event Tracing and Analysis</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#hardware-and-performance-tracing">Hardware and Performance Tracing</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intel_th.html">Intel(R) Trace Hub (TH)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stm.html">System Trace Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sys-t.html">MIPI SyS-T over STP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../coresight/index.html">CoreSight - ARM Hardware Trace</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Runtime Verification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hisi-ptt.html">HiSilicon PCIe Tune and Trace device</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmiotrace.html">In-kernel memory-mapped I/O tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hwlat_detector.html">Hardware Latency Detector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../osnoise-tracer.html">OSNOISE Tracer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../timerlat-tracer.html">Timerlat tracer</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#user-space-tracing">User-Space Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#additional-resources">Additional Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/trace/rv/monitor_rtapp.rst.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="real-time-application-monitors">
<h1>Real-time application monitors<a class="headerlink" href="#real-time-application-monitors" title="Link to this heading">¶</a></h1>
<ul class="simple">
<li><p>Name: rtapp</p></li>
<li><p>Type: container for multiple monitors</p></li>
<li><p>Author: Nam Cao &lt;<a class="reference external" href="mailto:namcao&#37;&#52;&#48;linutronix&#46;de">namcao<span>&#64;</span>linutronix<span>&#46;</span>de</a>&gt;</p></li>
</ul>
<section id="description">
<h2>Description<a class="headerlink" href="#description" title="Link to this heading">¶</a></h2>
<p>Real-time applications may have design flaws such that they experience
unexpected latency and fail to meet their time requirements. Often, these flaws
follow a few patterns:</p>
<blockquote>
<div><ul class="simple">
<li><p>Page faults: A real-time thread may access memory that does not have a
mapped physical backing or must first be copied (such as for copy-on-write).
Thus a page fault is raised and the kernel must first perform the expensive
action. This causes significant delays to the real-time thread</p></li>
<li><p>Priority inversion: A real-time thread blocks waiting for a lower-priority
thread. This causes the real-time thread to effectively take on the
scheduling priority of the lower-priority thread. For example, the real-time
thread needs to access a shared resource that is protected by a
non-pi-mutex, but the mutex is currently owned by a non-real-time thread.</p></li>
</ul>
</div></blockquote>
<p>The <cite>rtapp</cite> monitor detects these patterns. It aids developers to identify
reasons for unexpected latency with real-time applications. It is a container of
multiple sub-monitors described in the following sections.</p>
<section id="monitor-pagefault">
<h3>Monitor pagefault<a class="headerlink" href="#monitor-pagefault" title="Link to this heading">¶</a></h3>
<p>The <cite>pagefault</cite> monitor reports real-time tasks raising page faults. Its
specification is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RULE = always (RT imply not PAGEFAULT)
</pre></div>
</div>
<p>To fix warnings reported by this monitor, <cite><code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">mlockall()</span></code></cite> or <cite><code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">mlock()</span></code></cite> can be used
to ensure physical backing for memory.</p>
<p>This monitor may have false negatives because the pages used by the real-time
threads may just happen to be directly available during testing.  To minimize
this, the system can be put under memory pressure (e.g.  invoking the OOM killer
using a program that does <cite>ptr = malloc(SIZE_OF_RAM); memset(ptr, 0,
SIZE_OF_RAM);</cite>) so that the kernel executes aggressive strategies to recycle as
much physical memory as possible.</p>
</section>
<section id="monitor-sleep">
<h3>Monitor sleep<a class="headerlink" href="#monitor-sleep" title="Link to this heading">¶</a></h3>
<p>The <cite>sleep</cite> monitor reports real-time threads sleeping in a manner that may
cause undesirable latency. Real-time applications should only put a real-time
thread to sleep for one of the following reasons:</p>
<blockquote>
<div><ul class="simple">
<li><p>Cyclic work: real-time thread sleeps waiting for the next cycle. For this
case, only the <cite>clock_nanosleep</cite> syscall should be used with <cite>TIMER_ABSTIME</cite>
(to avoid time drift) and <cite>CLOCK_MONOTONIC</cite> (to avoid the clock being
changed). No other method is safe for real-time. For example, threads
waiting for timerfd can be woken by softirq which provides no real-time
guarantee.</p></li>
<li><p>Real-time thread waiting for something to happen (e.g. another thread
releasing shared resources, or a completion signal from another thread). In
this case, only futexes (FUTEX_LOCK_PI, FUTEX_LOCK_PI2 or one of
FUTEX_WAIT_*) should be used.  Applications usually do not use futexes
directly, but use PI mutexes and PI condition variables which are built on
top of futexes. Be aware that the C library might not implement conditional
variables as safe for real-time. As an alternative, the librtpi library
exists to provide a conditional variable implementation that is correct for
real-time applications in Linux.</p></li>
</ul>
</div></blockquote>
<p>Beside the reason for sleeping, the eventual waker should also be
real-time-safe. Namely, one of:</p>
<blockquote>
<div><ul class="simple">
<li><p>An equal-or-higher-priority thread</p></li>
<li><p>Hard interrupt handler</p></li>
<li><p>Non-maskable interrupt handler</p></li>
</ul>
</div></blockquote>
<p>This monitor's warning usually means one of the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>Real-time thread is blocked by a non-real-time thread (e.g. due to
contention on a mutex without priority inheritance). This is priority
inversion.</p></li>
<li><p>Time-critical work waits for something which is not safe for real-time (e.g.
timerfd).</p></li>
<li><p>The work executed by the real-time thread does not need to run at real-time
priority at all.  This is not a problem for the real-time thread itself, but
it is potentially taking the CPU away from other important real-time work.</p></li>
</ul>
</div></blockquote>
<p>Application developers may purposely choose to have their real-time application
sleep in a way that is not safe for real-time. It is debatable whether that is a
problem. Application developers must analyze the warnings to make a proper
assessment.</p>
<p>The monitor's specification is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RULE = always ((RT and SLEEP) imply (RT_FRIENDLY_SLEEP or ALLOWLIST))

RT_FRIENDLY_SLEEP = (RT_VALID_SLEEP_REASON or KERNEL_THREAD)
                and ((not WAKE) until RT_FRIENDLY_WAKE)

RT_VALID_SLEEP_REASON = FUTEX_WAIT
                     or RT_FRIENDLY_NANOSLEEP

RT_FRIENDLY_NANOSLEEP = CLOCK_NANOSLEEP
                    and NANOSLEEP_TIMER_ABSTIME
                    and NANOSLEEP_CLOCK_MONOTONIC

RT_FRIENDLY_WAKE = WOKEN_BY_EQUAL_OR_HIGHER_PRIO
                or WOKEN_BY_HARDIRQ
                or WOKEN_BY_NMI
                or KTHREAD_SHOULD_STOP

ALLOWLIST = BLOCK_ON_RT_MUTEX
         or FUTEX_LOCK_PI
         or TASK_IS_RCU
         or TASK_IS_MIGRATION
</pre></div>
</div>
<p>Beside the scenarios described above, this specification also handle some
special cases:</p>
<blockquote>
<div><ul class="simple">
<li><p><cite>KERNEL_THREAD</cite>: kernel tasks do not have any pattern that can be recognized
as valid real-time sleeping reasons. Therefore sleeping reason is not
checked for kernel tasks.</p></li>
<li><p><cite>KTHREAD_SHOULD_STOP</cite>: a non-real-time thread may stop a real-time kernel
thread by waking it and waiting for it to exit (<cite><a class="reference internal" href="../../driver-api/basics.html#c.kthread_stop" title="kthread_stop"><code class="xref c c-func docutils literal notranslate"><span class="pre">kthread_stop()</span></code></a></cite>). This
wakeup is safe for real-time.</p></li>
<li><p><cite>ALLOWLIST</cite>: to handle known false positives with the kernel.</p></li>
<li><p><cite>BLOCK_ON_RT_MUTEX</cite> is included in the allowlist due to its implementation.
In the release path of rt_mutex, a boosted task is de-boosted before waking
the rt_mutex's waiter. Consequently, the monitor may see a real-time-unsafe
wakeup (e.g. non-real-time task waking real-time task). This is actually
real-time-safe because preemption is disabled for the duration.</p></li>
<li><p><cite>FUTEX_LOCK_PI</cite> is included in the allowlist for the same reason as
<cite>BLOCK_ON_RT_MUTEX</cite>.</p></li>
</ul>
</div></blockquote>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/trace/rv/monitor_rtapp.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>