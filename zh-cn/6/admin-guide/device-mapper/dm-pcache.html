<!DOCTYPE html>

<html lang="zh-CN" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>dm-pcache — Persistent Cache &#8212; The Linux Kernel  文档</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=7d86a446"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=beaddf03"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/admin-guide/device-mapper/dm-pcache.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="dm-queue-length" href="dm-queue-length.html" />
    <link rel="prev" title="Device-Mapper Logging" href="dm-log.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.18.0-rc2</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="提交" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Administration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#general-guides-to-kernel-administration">General guides to kernel administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#booting-the-kernel">Booting the kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tracking-down-and-identifying-problems">Tracking down and identifying problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#core-kernel-subsystems">Core-kernel subsystems</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#block-layer-and-filesystem-administration">Block-layer and filesystem administration</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../bcache.html">A block layer cache (bcache)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../binderfs.html">The Android binderfs Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../blockdev/index.html">Block Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cifs/index.html">CIFS</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Device Mapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext4.html">ext4 General Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="../filesystem-monitoring.html">File system Monitoring with fanotify</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nfs/index.html">NFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../iostats.html">I/O statistics fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jfs.html">IBM's Journaled File System (JFS) for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../md.html">RAID arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ufs.html">Using UFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xfs.html">The SGI XFS Filesystem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#device-specific-guides">Device-specific guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#workload-analysis">Workload analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#everything-else">Everything else</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/device-mapper/dm-pcache.rst.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="dm-pcache-persistent-cache">
<h1>dm-pcache — Persistent Cache<a class="headerlink" href="#dm-pcache-persistent-cache" title="Link to this heading">¶</a></h1>
<p><em>Author: Dongsheng Yang &lt;dongsheng.yang&#64;linux.dev&gt;</em></p>
<p>This document describes <em>dm-pcache</em>, a Device-Mapper target that lets a
byte-addressable <em>DAX</em> (persistent-memory, “pmem”) region act as a
high-performance, crash-persistent cache in front of a slower block
device.  The code lives in <cite>drivers/md/dm-pcache/</cite>.</p>
<section id="quick-feature-summary">
<h2>Quick feature summary<a class="headerlink" href="#quick-feature-summary" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><em>Write-back</em> caching (only mode currently supported).</p></li>
<li><p><em>16 MiB segments</em> allocated on the pmem device.</p></li>
<li><p><em>Data CRC32</em> verification (optional, per cache).</p></li>
<li><p>Crash-safe: every metadata structure is duplicated (<cite>PCACHE_META_INDEX_MAX
== 2</cite>) and protected with CRC+sequence numbers.</p></li>
<li><p><em>Multi-tree indexing</em> (indexing trees sharded by logical address) for high PMem parallelism</p></li>
<li><p>Pure <em>DAX path</em> I/O – no extra BIO round-trips</p></li>
<li><p><em>Log-structured write-back</em> that preserves backend crash-consistency</p></li>
</ul>
</section>
<section id="constructor">
<h2>Constructor<a class="headerlink" href="#constructor" title="Link to this heading">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pcache &lt;cache_dev&gt; &lt;backing_dev&gt; [&lt;number_of_optional_arguments&gt; &lt;cache_mode writeback&gt; &lt;data_crc true|false&gt;]
</pre></div>
</div>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">cache_dev</span></code></p></td>
<td><p>Any DAX-capable block device (<code class="docutils literal notranslate"><span class="pre">/dev/pmem0</span></code>…).
All metadata <em>and</em> cached blocks are stored here.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">backing_dev</span></code></p></td>
<td><p>The slow block device to be cached.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">cache_mode</span></code></p></td>
<td><p>Optional, Only <code class="docutils literal notranslate"><span class="pre">writeback</span></code> is accepted at the
moment.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">data_crc</span></code></p></td>
<td><p>Optional, default to <code class="docutils literal notranslate"><span class="pre">false</span></code></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>  – store CRC32 for every cached entry
and verify on reads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code> – skip CRC (faster)</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Link to this heading">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dmsetup<span class="w"> </span>create<span class="w"> </span>pcache_sdb<span class="w"> </span>--table<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;0 </span><span class="k">$(</span>blockdev<span class="w"> </span>--getsz<span class="w"> </span>/dev/sdb<span class="k">)</span><span class="s2"> pcache /dev/pmem0 /dev/sdb 4 cache_mode writeback data_crc true&quot;</span>
</pre></div>
</div>
<p>The first time a pmem device is used, dm-pcache formats it automatically
(super-block, cache_info, etc.).</p>
</section>
</section>
<section id="status-line">
<h2>Status line<a class="headerlink" href="#status-line" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">dmsetup</span> <span class="pre">status</span> <span class="pre">&lt;device&gt;</span></code> (<code class="docutils literal notranslate"><span class="pre">STATUSTYPE_INFO</span></code>) prints:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;sb_flags&gt; &lt;seg_total&gt; &lt;cache_segs&gt; &lt;segs_used&gt; \
&lt;gc_percent&gt; &lt;cache_flags&gt; \
&lt;key_head_seg&gt;:&lt;key_head_off&gt; \
&lt;dirty_tail_seg&gt;:&lt;dirty_tail_off&gt; \
&lt;key_tail_seg&gt;:&lt;key_tail_off&gt;
</pre></div>
</div>
<section id="field-meanings">
<h3>Field meanings<a class="headerlink" href="#field-meanings" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sb_flags</span></code></p></td>
<td><p>Super-block flags (e.g. endian marker).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">seg_total</span></code></p></td>
<td><p>Number of physical <em>pmem</em> segments.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">cache_segs</span></code></p></td>
<td><p>Number of segments used for cache.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">segs_used</span></code></p></td>
<td><p>Segments currently allocated (bitmap weight).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">gc_percent</span></code></p></td>
<td><p>Current GC high-water mark (0-90).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cache_flags</span></code></p></td>
<td><p>Bit 0 – DATA_CRC enabled
Bit 1 – INIT_DONE (cache initialised)
Bits 2-5 – cache mode (0 == WB).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">key_head</span></code></p></td>
<td><p>Where new key-sets are being written.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">dirty_tail</span></code></p></td>
<td><p>First dirty key-set that still needs
write-back to the backing device.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">key_tail</span></code></p></td>
<td><p>First key-set that may be reclaimed by GC.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="messages">
<h2>Messages<a class="headerlink" href="#messages" title="Link to this heading">¶</a></h2>
<p><em>Change GC trigger</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup message &lt;dev&gt; 0 gc_percent &lt;0-90&gt;
</pre></div>
</div>
</section>
<section id="theory-of-operation">
<h2>Theory of operation<a class="headerlink" href="#theory-of-operation" title="Link to this heading">¶</a></h2>
<section id="sub-devices">
<h3>Sub-devices<a class="headerlink" href="#sub-devices" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>backing_dev</p></td>
<td><p>Any block device (SSD/HDD/loop/LVM, etc.).</p></td>
</tr>
<tr class="row-even"><td><p>cache_dev</p></td>
<td><p>DAX device; must expose direct-access memory.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="segments-and-key-sets">
<h3>Segments and key-sets<a class="headerlink" href="#segments-and-key-sets" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>The pmem space is divided into <em>16 MiB segments</em>.</p></li>
<li><p>Each write allocates space from a per-CPU <em>data_head</em> inside a segment.</p></li>
<li><p>A <em>cache-key</em> records a logical range on the origin and where it lives
inside pmem (segment + offset + generation).</p></li>
<li><p>128 keys form a <em>key-set</em> (kset); ksets are written sequentially in pmem
and are themselves crash-safe (CRC).</p></li>
<li><p>The pair <em>(key_tail, dirty_tail)</em> delimit clean/dirty and live/dead ksets.</p></li>
</ul>
</section>
<section id="write-back">
<h3>Write-back<a class="headerlink" href="#write-back" title="Link to this heading">¶</a></h3>
<p>Dirty keys are queued into a tree; a background worker copies data
back to the backing_dev and advances <em>dirty_tail</em>.  A FLUSH/FUA bio from the
upper layers forces an immediate metadata commit.</p>
</section>
<section id="garbage-collection">
<h3>Garbage collection<a class="headerlink" href="#garbage-collection" title="Link to this heading">¶</a></h3>
<p>GC starts when <code class="docutils literal notranslate"><span class="pre">segs_used</span> <span class="pre">&gt;=</span> <span class="pre">seg_total</span> <span class="pre">*</span> <span class="pre">gc_percent</span> <span class="pre">/</span> <span class="pre">100</span></code>.  It walks
from <em>key_tail</em>, frees segments whose every key has been invalidated, and
advances <em>key_tail</em>.</p>
</section>
<section id="crc-verification">
<h3>CRC verification<a class="headerlink" href="#crc-verification" title="Link to this heading">¶</a></h3>
<p>If <code class="docutils literal notranslate"><span class="pre">data_crc</span> <span class="pre">is</span> <span class="pre">enabled</span></code> dm-pcache computes a CRC32 over every cached data
range when it is inserted and stores it in the on-media key.  Reads
validate the CRC before copying to the caller.</p>
</section>
</section>
<section id="failure-handling">
<h2>Failure handling<a class="headerlink" href="#failure-handling" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><em>pmem media errors</em> – all metadata copies are read with
<code class="docutils literal notranslate"><span class="pre">copy_mc_to_kernel</span></code>; an uncorrectable error logs and aborts initialisation.</p></li>
<li><p><em>Cache full</em> – if no free segment can be found, writes return <code class="docutils literal notranslate"><span class="pre">-EBUSY</span></code>;
dm-pcache retries internally (request deferral).</p></li>
<li><p><em>System crash</em> – on attach, the driver replays ksets from <em>key_tail</em> to
rebuild the in-core trees; every segment’s generation guards against
use-after-free keys.</p></li>
</ul>
</section>
<section id="limitations-todo">
<h2>Limitations &amp; TODO<a class="headerlink" href="#limitations-todo" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Only <em>write-back</em> mode; other modes planned.</p></li>
<li><p>Only FIFO cache invalidate; other (LRU, ARC...) planned.</p></li>
<li><p>Table reload is not supported currently.</p></li>
<li><p>Discard planned.</p></li>
</ul>
</section>
<section id="example-workflow">
<h2>Example workflow<a class="headerlink" href="#example-workflow" title="Link to this heading">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.  Create devices</span>
dmsetup<span class="w"> </span>create<span class="w"> </span>pcache_sdb<span class="w"> </span>--table<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;0 </span><span class="k">$(</span>blockdev<span class="w"> </span>--getsz<span class="w"> </span>/dev/sdb<span class="k">)</span><span class="s2"> pcache /dev/pmem0 /dev/sdb 4 cache_mode writeback data_crc true&quot;</span>

<span class="c1"># 2.  Put a filesystem on top</span>
mkfs.ext4<span class="w"> </span>/dev/mapper/pcache_sdb
mount<span class="w"> </span>/dev/mapper/pcache_sdb<span class="w"> </span>/mnt

<span class="c1"># 3.  Tune GC threshold to 80 %</span>
dmsetup<span class="w"> </span>message<span class="w"> </span>pcache_sdb<span class="w"> </span><span class="m">0</span><span class="w"> </span>gc_percent<span class="w"> </span><span class="m">80</span>

<span class="c1"># 4.  Observe status</span>
watch<span class="w"> </span>-n1<span class="w"> </span><span class="s1">&#39;dmsetup status pcache_sdb&#39;</span>

<span class="c1"># 5.  Shutdown</span>
umount<span class="w"> </span>/mnt
dmsetup<span class="w"> </span>remove<span class="w"> </span>pcache_sdb
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">dm-pcache</span></code> is under active development; feedback, bug reports and patches
are very welcome!</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/admin-guide/device-mapper/dm-pcache.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>