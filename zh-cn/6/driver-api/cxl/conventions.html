<!DOCTYPE html>

<html lang="zh-CN" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Compute Express Link: Linux Conventions &#8212; The Linux Kernel  文档</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=7d86a446"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=beaddf03"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/driver-api/cxl/conventions.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Devices and Protocols" href="devices/device-types.html" />
    <link rel="prev" title="Compute Express Link Subsystem Maturity Map" href="maturity-map.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.18.0-rc2</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="提交" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Driver APIs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#general-information-for-driver-authors">General information for driver authors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#useful-support-libraries">Useful support libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#bus-level-documentation">Bus-level documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../auxiliary_bus.html">Auxiliary Bus</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Compute Express Link</a></li>
<li class="toctree-l3"><a class="reference internal" href="../eisa.html">EISA bus support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../firewire.html">Firewire (IEEE 1394) driver Interface Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../i3c/index.html">I3C subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../isa.html">ISA Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../men-chameleon-bus.html">MEN Chameleon Bus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pci/index.html">The Linux PCI driver implementer's API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rapidio/index.html">The Linux RapidIO Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../slimbus.html">Linux kernel SLIMbus support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../usb/index.html">Linux USB API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../virtio/index.html">Virtio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vme.html">VME Device Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../w1.html">W1: Dallas' 1-wire bus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xillybus.html">Xillybus driver for generic FPGA interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#subsystem-specific-apis">Subsystem-specific APIs</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../subsystem-apis.html#core-subsystems">Core subsystems</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Driver implementer's API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mm/index.html">Memory Management Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../scheduler/index.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../timers/index.html">Timers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/driver-api/cxl/conventions.rst.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="compute-express-link-linux-conventions">
<h1>Compute Express Link: Linux Conventions<a class="headerlink" href="#compute-express-link-linux-conventions" title="Link to this heading">¶</a></h1>
<p>There exists shipping platforms that bend or break CXL specification
expectations. Record the details and the rationale for those deviations.
Borrow the ACPI Code First template format to capture the assumptions
and tradeoffs such that multiple platform implementations can follow the
same convention.</p>
<section id="template-title">
<h2>&lt;(template) Title&gt;<a class="headerlink" href="#template-title" title="Link to this heading">¶</a></h2>
<section id="document">
<h3>Document<a class="headerlink" href="#document" title="Link to this heading">¶</a></h3>
<p>CXL Revision &lt;rev&gt;, Version &lt;ver&gt;</p>
</section>
<section id="license">
<h3>License<a class="headerlink" href="#license" title="Link to this heading">¶</a></h3>
<p>SPDX-License Identifier: CC-BY-4.0</p>
</section>
<section id="creator-contributors">
<h3>Creator/Contributors<a class="headerlink" href="#creator-contributors" title="Link to this heading">¶</a></h3>
</section>
<section id="summary-of-the-change">
<h3>Summary of the Change<a class="headerlink" href="#summary-of-the-change" title="Link to this heading">¶</a></h3>
<p>&lt;Detail the conflict with the specification and where available the
assumptions and tradeoffs taken by the hardware platform.&gt;</p>
</section>
<section id="benefits-of-the-change">
<h3>Benefits of the Change<a class="headerlink" href="#benefits-of-the-change" title="Link to this heading">¶</a></h3>
<p>&lt;Detail what happens if platforms and Linux do not adopt this
convention.&gt;</p>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">¶</a></h3>
</section>
<section id="detailed-description-of-the-change">
<h3>Detailed Description of the Change<a class="headerlink" href="#detailed-description-of-the-change" title="Link to this heading">¶</a></h3>
<p>&lt;Propose spec language that corrects the conflict.&gt;</p>
</section>
</section>
<section id="resolve-conflict-between-cfmws-platform-memory-holes-and-endpoint-decoders">
<h2>Resolve conflict between CFMWS, Platform Memory Holes, and Endpoint Decoders<a class="headerlink" href="#resolve-conflict-between-cfmws-platform-memory-holes-and-endpoint-decoders" title="Link to this heading">¶</a></h2>
<section id="id1">
<h3>Document<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>CXL Revision 3.2, Version 1.0</p>
</section>
<section id="id2">
<h3>License<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>SPDX-License Identifier: CC-BY-4.0</p>
</section>
<section id="id3">
<h3>Creator/Contributors<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Fabio M. De Francesco, Intel</p></li>
<li><p>Dan J. Williams, Intel</p></li>
<li><p>Mahesh Natu, Intel</p></li>
</ul>
</section>
<section id="id4">
<h3>Summary of the Change<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<p>According to the current Compute Express Link (CXL) Specifications (Revision
3.2, Version 1.0), the CXL Fixed Memory Window Structure (CFMWS) describes zero
or more Host Physical Address (HPA) windows associated with each CXL Host
Bridge. Each window represents a contiguous HPA range that may be interleaved
across one or more targets, including CXL Host Bridges. Each window has a set
of restrictions that govern its usage. It is the Operating System-directed
configuration and Power Management (OSPM) responsibility to utilize each window
for the specified use.</p>
<p>Table 9-22 of the current CXL Specifications states that the Window Size field
contains the total number of consecutive bytes of HPA this window describes.
This value must be a multiple of the Number of Interleave Ways (NIW) * 256 MB.</p>
<p>Platform Firmware (BIOS) might reserve physical addresses below 4 GB where a
memory gap such as the Low Memory Hole for PCIe MMIO may exist. In such cases,
the CFMWS Range Size may not adhere to the NIW * 256 MB rule.</p>
<p>The HPA represents the actual physical memory address space that the CXL devices
can decode and respond to, while the System Physical Address (SPA), a related
but distinct concept, represents the system-visible address space that users can
direct transaction to and so it excludes reserved regions.</p>
<p>BIOS publishes CFMWS to communicate the active SPA ranges that, on platforms
with LMH's, map to a strict subset of the HPA. The SPA range trims out the hole,
resulting in lost capacity in the Endpoints with no SPA to map to that part of
the HPA range that intersects the hole.</p>
<p>E.g, an x86 platform with two CFMWS and an LMH starting at 2 GB:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Window</p></th>
<th class="head"><p>CFMWS Base</p></th>
<th class="head"><p>CFMWS Size</p></th>
<th class="head"><p>HDM Decoder Base</p></th>
<th class="head"><p>HDM Decoder Size</p></th>
<th class="head"><p>Ways</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>0 GB</p></td>
<td><p>2 GB</p></td>
<td><p>0 GB</p></td>
<td><p>3 GB</p></td>
<td><p>12</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>4 GB</p></td>
<td><p>NIW*256MB Aligned</p></td>
<td><p>4 GB</p></td>
<td><p>NIW*256MB Aligned</p></td>
<td><p>12</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>HDM decoder base and HDM decoder size represent all the 12 Endpoint Decoders of
a 12 ways region and all the intermediate Switch Decoders. They are configured
by the BIOS according to the NIW * 256MB rule, resulting in a HPA range size of
3GB. Instead, the CFMWS Base and CFMWS Size are used to configure the Root
Decoder HPA range that results smaller (2GB) than that of the Switch and
Endpoint Decoders in the hierarchy (3GB).</p>
<p>This creates 2 issues which lead to a failure to construct a region:</p>
<ol class="arabic simple">
<li><p>A mismatch in region size between root and any HDM decoder. The root decoders
will always be smaller due to the trim.</p></li>
<li><p>The trim causes the root decoder to violate the (NIW * 256MB) rule.</p></li>
</ol>
<p>This change allows a region with a base address of 0GB to bypass these checks to
allow for region creation with the trimmed root decoder address range.</p>
<p>This change does not allow for any other arbitrary region to violate these
checks - it is intended exclusively to enable x86 platforms which map CXL memory
under 4GB.</p>
<p>Despite the HDM decoders covering the PCIE hole HPA region, it is expected that
the platform will never route address accesses to the CXL complex because the
root decoder only covers the trimmed region (which excludes this). This is
outside the ability of Linux to enforce.</p>
<p>On the example platform, only the first 2GB will be potentially usable, but
Linux, aiming to adhere to the current specifications, fails to construct
Regions and attach Endpoint and intermediate Switch Decoders to them.</p>
<p>There are several points of failure that due to the expectation that the Root
Decoder HPA size, that is equal to the CFMWS from which it is configured, has
to be greater or equal to the matching Switch and Endpoint HDM Decoders.</p>
<p>In order to succeed with construction and attachment, Linux must construct a
Region with Root Decoder HPA range size, and then attach to that all the
intermediate Switch Decoders and Endpoint Decoders that belong to the hierarchy
regardless of their range sizes.</p>
</section>
<section id="id5">
<h3>Benefits of the Change<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>Without the change, the OSPM wouldn't match intermediate Switch and Endpoint
Decoders with Root Decoders configured with CFMWS HPA sizes that don't align
with the NIW * 256MB constraint, and so it leads to lost memdev capacity.</p>
<p>This change allows the OSPM to construct Regions and attach intermediate Switch
and Endpoint Decoders to them, so that the addressable part of the memory
devices total capacity is made available to the users.</p>
</section>
<section id="id6">
<h3>References<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h3>
<p>Compute Express Link Specification Revision 3.2, Version 1.0
&lt;<a class="reference external" href="https://www.computeexpresslink.org/">https://www.computeexpresslink.org/</a>&gt;</p>
</section>
<section id="id7">
<h3>Detailed Description of the Change<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h3>
<p>The description of the Window Size field in table 9-22 needs to account for
platforms with Low Memory Holes, where SPA ranges might be subsets of the
endpoints HPA. Therefore, it has to be changed to the following:</p>
<p>&quot;The total number of consecutive bytes of HPA this window represents. This value
shall be a multiple of NIW * 256 MB.</p>
<p>On platforms that reserve physical addresses below 4 GB, such as the Low Memory
Hole for PCIe MMIO on x86, an instance of CFMWS whose Base HPA range is 0 might
have a size that doesn't align with the NIW * 256 MB constraint.</p>
<p>Note that the matching intermediate Switch Decoders and the Endpoint Decoders
HPA range sizes must still align to the above-mentioned rule, but the memory
capacity that exceeds the CFMWS window size won't be accessible.&quot;.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/driver-api/cxl/conventions.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>