<!DOCTYPE html>

<html lang="zh-CN" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Deterministic Automata Instrumentation &#8212; The Linux Kernel unknown version 文档</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../_static/documentation_options.js?v=c459948e"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=beaddf03"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/trace/rv/da_monitor_instrumentation.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Monitor wip" href="monitor_wip.html" />
    <link rel="prev" title="Runtime Verification Monitor Synthesis" href="monitor_synthesis.html" />

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="提交" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tracing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#introduction-to-tracing">Introduction to Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#core-tracing-frameworks">Core Tracing Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#event-tracing-and-analysis">Event Tracing and Analysis</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#hardware-and-performance-tracing">Hardware and Performance Tracing</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intel_th.html">Intel(R) Trace Hub (TH)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stm.html">System Trace Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sys-t.html">MIPI SyS-T over STP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../coresight/index.html">CoreSight - ARM Hardware Trace</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Runtime Verification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hisi-ptt.html">HiSilicon PCIe Tune and Trace device</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmiotrace.html">In-kernel memory-mapped I/O tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hwlat_detector.html">Hardware Latency Detector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../osnoise-tracer.html">OSNOISE Tracer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../timerlat-tracer.html">Timerlat tracer</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#user-space-tracing">User-Space Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#additional-resources">Additional Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/trace/rv/da_monitor_instrumentation.rst.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="deterministic-automata-instrumentation">
<h1>Deterministic Automata Instrumentation<a class="headerlink" href="#deterministic-automata-instrumentation" title="Link to this heading">¶</a></h1>
<p>The RV monitor file created by dot2k, with the name &quot;$MODEL_NAME.c&quot;
includes a section dedicated to instrumentation.</p>
<p>In the example of the wip.dot monitor created on [1], it will look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/*
 * This is the instrumentation part of the monitor.
 *
 * This is the section where manual work is required. Here the kernel events
 * are translated into model&#39;s event.
 *
 */
static void handle_preempt_disable(void *data, /* XXX: fill header */)
{
      da_handle_event_wip(preempt_disable_wip);
}

static void handle_preempt_enable(void *data, /* XXX: fill header */)
{
      da_handle_event_wip(preempt_enable_wip);
}

static void handle_sched_waking(void *data, /* XXX: fill header */)
{
      da_handle_event_wip(sched_waking_wip);
}

static int enable_wip(void)
{
      int retval;

      retval = da_monitor_init_wip();
      if (retval)
              return retval;

      rv_attach_trace_probe(&quot;wip&quot;, /* XXX: tracepoint */, handle_preempt_disable);
      rv_attach_trace_probe(&quot;wip&quot;, /* XXX: tracepoint */, handle_preempt_enable);
      rv_attach_trace_probe(&quot;wip&quot;, /* XXX: tracepoint */, handle_sched_waking);

      return 0;
}
</pre></div>
</div>
<p>The comment at the top of the section explains the general idea: the
instrumentation section translates <em>kernel events</em> into the <em>model's
event</em>.</p>
<section id="tracing-callback-functions">
<h2>Tracing callback functions<a class="headerlink" href="#tracing-callback-functions" title="Link to this heading">¶</a></h2>
<p>The first three functions are the starting point of the callback <em>handler
functions</em> for each of the three events from the wip model. The developer
does not necessarily need to use them: they are just starting points.</p>
<p>Using the example of:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void handle_preempt_disable(void *data, /* XXX: fill header */)
{
       da_handle_event_wip(preempt_disable_wip);
}
</pre></div>
</div>
<p>The preempt_disable event from the model connects directly to the
preemptirq:preempt_disable. The preemptirq:preempt_disable event
has the following signature, from include/trace/events/preemptirq.h:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_PROTO(unsigned long ip, unsigned long parent_ip)
</pre></div>
</div>
<p>Hence, the <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">handle_preempt_disable()</span></code> function will look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void handle_preempt_disable(void *data, unsigned long ip, unsigned long parent_ip)
</pre></div>
</div>
<p>In this case, the kernel event translates one to one with the automata
event, and indeed, no other change is required for this function.</p>
<p>The next handler function, <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">handle_preempt_enable()</span></code> has the same argument
list from the <code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">handle_preempt_disable()</span></code>. The difference is that the
preempt_enable event will be used to synchronize the system to the model.</p>
<p>Initially, the <em>model</em> is placed in the initial state. However, the <em>system</em>
might or might not be in the initial state. The monitor cannot start
processing events until it knows that the system has reached the initial state.
Otherwise, the monitor and the system could be out-of-sync.</p>
<p>Looking at the automata definition, it is possible to see that the system
and the model are expected to return to the initial state after the
preempt_enable execution. Hence, it can be used to synchronize the
system and the model at the initialization of the monitoring section.</p>
<p>The start is informed via a special handle function, the
&quot;da_handle_start_event_$(MONITOR_NAME)(event)&quot;, in this case:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>da_handle_start_event_wip(preempt_enable_wip);
</pre></div>
</div>
<p>So, the callback function will look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void handle_preempt_enable(void *data, unsigned long ip, unsigned long parent_ip)
{
      da_handle_start_event_wip(preempt_enable_wip);
}
</pre></div>
</div>
<p>Finally, the &quot;<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">handle_sched_waking()</span></code>&quot; will look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void handle_sched_waking(void *data, struct task_struct *task)
{
      da_handle_event_wip(sched_waking_wip);
}
</pre></div>
</div>
<p>And the explanation is left for the reader as an exercise.</p>
</section>
<section id="enable-and-disable-functions">
<h2>enable and disable functions<a class="headerlink" href="#enable-and-disable-functions" title="Link to this heading">¶</a></h2>
<p>dot2k automatically creates two special functions:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>enable_$(MONITOR_NAME)()
disable_$(MONITOR_NAME)()
</pre></div>
</div>
<p>These functions are called when the monitor is enabled and disabled,
respectively.</p>
<p>They should be used to <em>attach</em> and <em>detach</em> the instrumentation to the running
system. The developer must add to the relative function all that is needed to
<em>attach</em> and <em>detach</em> its monitor to the system.</p>
<p>For the wip case, these functions were named:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>enable_wip()
disable_wip()
</pre></div>
</div>
<p>But no change was required because: by default, these functions <em>attach</em> and
<em>detach</em> the tracepoints_to_attach, which was enough for this case.</p>
</section>
<section id="instrumentation-helpers">
<h2>Instrumentation helpers<a class="headerlink" href="#instrumentation-helpers" title="Link to this heading">¶</a></h2>
<p>To complete the instrumentation, the <em>handler functions</em> need to be attached to a
kernel event, at the monitoring enable phase.</p>
<p>The RV interface also facilitates this step. For example, the macro &quot;<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">rv_attach_trace_probe()</span></code>&quot;
is used to connect the wip model events to the relative kernel event. dot2k automatically
adds &quot;<code class="xref c c-func broken_xref docutils literal notranslate"><span class="pre">rv_attach_trace_probe()</span></code>&quot; function call for each model event in the enable phase, as
a suggestion.</p>
<p>For example, from the wip sample model:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static int enable_wip(void)
{
      int retval;

      retval = da_monitor_init_wip();
      if (retval)
              return retval;

      rv_attach_trace_probe(&quot;wip&quot;, /* XXX: tracepoint */, handle_preempt_enable);
      rv_attach_trace_probe(&quot;wip&quot;, /* XXX: tracepoint */, handle_sched_waking);
      rv_attach_trace_probe(&quot;wip&quot;, /* XXX: tracepoint */, handle_preempt_disable);

      return 0;
}
</pre></div>
</div>
<p>The probes then need to be detached at the disable phase.</p>
<p>[1] The wip model is presented in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Documentation/trace/rv/deterministic_automata.rst
</pre></div>
</div>
<p>The wip monitor is presented in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Documentation/trace/rv/da_monitor_synthesis.rst
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/trace/rv/da_monitor_instrumentation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>