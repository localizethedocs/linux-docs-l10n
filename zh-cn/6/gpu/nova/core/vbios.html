<!DOCTYPE html>

<html lang="zh-CN" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>VBIOS &#8212; The Linux Kernel unknown version 文档</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=adfc0c0d" />
    <script src="../../../_static/documentation_options.js?v=c459948e"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/translations.js?v=beaddf03"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/linux-docs-l10n/gpu/nova/core/vbios.html" />
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="Device Initialization (devinit)" href="devinit.html" />
    <link rel="prev" title="Task List" href="todo.html" />

   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="../../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../../ltd-flyout.js"></script>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.19.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="提交" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>


<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../subsystem-apis.html#human-interfaces">Human interfaces</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../input/index.html">Input Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sound/index.html">Sound Subsystem Documentation</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../index.html">GPU Driver Developer's Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../leds/index.html">LEDs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted documentation</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/gpu/nova/core/vbios.rst.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="vbios">
<h1>VBIOS<a class="headerlink" href="#vbios" title="Link to this heading">¶</a></h1>
<p>This document describes the layout of the VBIOS image which is a series of concatenated
images in the ROM of the GPU. The VBIOS is mirrored onto the BAR 0 space and is read
by both Boot ROM firmware (also known as IFR or init-from-rom firmware) on the GPU to
bootstrap various microcontrollers (PMU, SEC, GSP) with critical initialization before
the driver loads, as well as by the nova-core driver in the kernel to boot the GSP.</p>
<p>The format of the images in the ROM follow the &quot;BIOS Specification&quot; part of the
PCI specification, with Nvidia-specific extensions. The ROM images of type FwSec
are the ones that contain Falcon ucode and what we are mainly looking for.</p>
<p>As an example, the following are the different image types that can be found in the
VBIOS of an Ampere GA102 GPU which is supported by the nova-core driver.</p>
<ul class="simple">
<li><p>PciAt Image (Type 0x00) - This is the standard PCI BIOS image, whose name
likely comes from the &quot;IBM PC/AT&quot; architecture.</p></li>
<li><p>EFI Image (Type 0x03) - This is the EFI BIOS image. It contains the UEFI GOP
driver that is used to display UEFI graphics output.</p></li>
<li><p>First FwSec Image (Type 0xE0) - The first FwSec image (Secure Firmware)</p></li>
<li><p>Second FwSec Image (Type 0xE0) - The second FwSec image (Secure Firmware)
contains various  microcodes (also known as an applications) that do a range
of different functions. The FWSEC ucode is run in heavy-secure mode and
typically runs directly on the GSP (it could be running on a different
designated processor in future generations but as of Ampere, it is the GSP).
This firmware then loads other firmware ucodes onto the PMU and SEC2
microcontrollers for gfw initialization after GPU reset and before the driver
loads (see <a class="reference internal" href="devinit.html"><span class="doc">Device Initialization (devinit)</span></a>). The DEVINIT ucode is itself another ucode that is
stored in this ROM partition.</p></li>
</ul>
<p>Once located, the Falcon ucodes have &quot;Application Interfaces&quot; in their data
memory (DMEM). For FWSEC, the application interface we use for FWSEC is the
&quot;DMEM mapper&quot; interface which is configured to run the &quot;FRTS&quot; command. This
command carves out the WPR2 (Write-Protected Region) in VRAM. It then places
important power-management data, called 'FRTS', into this region. The WPR2
region is only accessible to heavy-secure ucode.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>It is not clear why FwSec has 2 different partitions in the ROM, but they both
are of type 0xE0 and can be identified as such. This could be subject to change
in future generations.</p>
</div>
<section id="vbios-rom-layout">
<h2>VBIOS ROM Layout<a class="headerlink" href="#vbios-rom-layout" title="Link to this heading">¶</a></h2>
<p>The VBIOS layout is roughly a series of concatenated images laid out as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------------------------------------------------------------------------+
| VBIOS (Starting at ROM_OFFSET: 0x300000)                                   |
+----------------------------------------------------------------------------+
| +-----------------------------------------------+                          |
| | PciAt Image (Type 0x00)                       |                          |
| +-----------------------------------------------+                          |
| | +-------------------+                         |                          |
| | | ROM Header        |                         |                          |
| | | (Signature 0xAA55)|                         |                          |
| | +-------------------+                         |                          |
| |         | rom header&#39;s pci_data_struct_offset |                          |
| |         | points to the PCIR structure        |                          |
| |         V                                     |                          |
| | +-------------------+                         |                          |
| | | PCIR Structure    |                         |                          |
| | | (Signature &quot;PCIR&quot;)|                         |                          |
| | | last_image: 0x80  |                         |                          |
| | | image_len: size   |                         |                          |
| | | in 512-byte units |                         |                          |
| | +-------------------+                         |                          |
| |         |                                     |                          |
| |         | NPDE immediately follows PCIR       |                          |
| |         V                                     |                          |
| | +-------------------+                         |                          |
| | | NPDE Structure    |                         |                          |
| | | (Signature &quot;NPDE&quot;)|                         |                          |
| | | last_image: 0x00  |                         |                          |
| | +-------------------+                         |                          |
| |                                               |                          |
| | +-------------------+                         |                          |
| | | BIT Header        | (Signature scanning     |                          |
| | | (Signature &quot;BIT&quot;) |  provides the location  |                          |
| | +-------------------+  of the BIT table)      |                          |
| |         | header is                           |                          |
| |         | followed by a table of tokens       |                          |
| |         V one of which is for falcon data.    |                          |
| | +-------------------+                         |                          |
| | | BIT Tokens        |                         |                          |
| | |  ______________   |                         |                          |
| | | | Falcon Data |   |                         |                          |
| | | | Token (0x70)|---+------------&gt;------------+--+                       |
| | | +-------------+   |  falcon_data_ptr()      |  |                       |
| | +-------------------+                         |  V                       |
| +-----------------------------------------------+  |                       |
|              (no gap between images)               |                       |
| +-----------------------------------------------+  |                       |
| | EFI Image (Type 0x03)                         |  |                       |
| +-----------------------------------------------+  |                       |
| | Contains the UEFI GOP driver (Graphics Output)|  |                       |
| | +-------------------+                         |  |                       |
| | | ROM Header        |                         |  |                       |
| | +-------------------+                         |  |                       |
| | | PCIR Structure    |                         |  |                       |
| | +-------------------+                         |  |                       |
| | | NPDE Structure    |                         |  |                       |
| | +-------------------+                         |  |                       |
| | | Image data        |                         |  |                       |
| | +-------------------+                         |  |                       |
| +-----------------------------------------------+  |                       |
|              (no gap between images)               |                       |
| +-----------------------------------------------+  |                       |
| | First FwSec Image (Type 0xE0)                 |  |                       |
| +-----------------------------------------------+  |                       |
| | +-------------------+                         |  |                       |
| | | ROM Header        |                         |  |                       |
| | +-------------------+                         |  |                       |
| | | PCIR Structure    |                         |  |                       |
| | +-------------------+                         |  |                       |
| | | NPDE Structure    |                         |  |                       |
| | +-------------------+                         |  |                       |
| | | Image data        |                         |  |                       |
| | +-------------------+                         |  |                       |
| +-----------------------------------------------+  |                       |
|              (no gap between images)               |                       |
| +-----------------------------------------------+  |                       |
| | Second FwSec Image (Type 0xE0)                |  |                       |
| +-----------------------------------------------+  |                       |
| | +-------------------+                         |  |                       |
| | | ROM Header        |                         |  |                       |
| | +-------------------+                         |  |                       |
| | | PCIR Structure    |                         |  |                       |
| | +-------------------+                         |  |                       |
| | | NPDE Structure    |                         |  |                       |
| | +-------------------+                         |  |                       |
| |                                               |  |                       |
| | +-------------------+                         |  |                       |
| | | PMU Lookup Table  | &lt;- falcon_data_offset &lt;----+                       |
| | | +-------------+   |    pmu_lookup_table     |                          |
| | | | Entry 0x85  |   |                         |                          |
| | | | FWSEC_PROD  |   |                         |                          |
| | | +-------------+   |                         |                          |
| | +-------------------+                         |                          |
| |         |                                     |                          |
| |         | points to                           |                          |
| |         V                                     |                          |
| | +-------------------+                         |                          |
| | | FalconUCodeDescV3 | &lt;- falcon_ucode_offset  |                          |
| | | (FWSEC Firmware)  |    fwsec_header()       |                          |
| | +-------------------+                         |                          |
| |         |   immediately followed  by...       |                          |
| |         V                                     |                          |
| | +----------------------------+                |                          |
| | | Signatures + FWSEC Ucode   |                |                          |
| | | fwsec_sigs(), fwsec_ucode()|                |                          |
| | +----------------------------+                |                          |
| +-----------------------------------------------+                          |
|                                                                            |
+----------------------------------------------------------------------------+
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>This diagram is created based on an GA-102 Ampere GPU as an example and could
vary for future or other GPUs.</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>For more explanations of acronyms, see the detailed descriptions in <cite>vbios.rs</cite>.</p>
</div>
</section>
<section id="falcon-data-lookup">
<h2>Falcon data Lookup<a class="headerlink" href="#falcon-data-lookup" title="Link to this heading">¶</a></h2>
<p>A key part of the VBIOS extraction code (vbios.rs) is to find the location of the
Falcon data in the VBIOS which contains the PMU lookup table. This lookup table is
used to find the required Falcon ucode based on an application ID.</p>
<p>The location of the PMU lookup table is found by scanning the BIT (<a class="reference external" href="https://download.nvidia.com/open-gpu-doc/BIOS-Information-Table/1/BIOS-Information-Table.html">BIOS Information Table</a>)
tokens for a token with the id <cite>BIT_TOKEN_ID_FALCON_DATA</cite> (0x70) which indicates the
offset of the same from the start of the VBIOS image. Unfortunately, the offset
does not account for the EFI image located between the PciAt and FwSec images.
The <cite>vbios.rs</cite> code compensates for this with appropriate arithmetic.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../../_sources/gpu/nova/core/vbios.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>